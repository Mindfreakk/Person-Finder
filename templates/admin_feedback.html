{% extends "base.html" %}

{% block title %}Feedback - Admin Panel{% endblock %}

{% block content %}
<!-- Spacer / matching dashboard pattern -->
<header class="bg-transparent relative z-50 p-6 flex justify-between items-center shadow-md"></header>

<!-- Full-bleed blue header (same style as Admin Dashboard) -->
<div class="w-full bg-blue-900 text-white p-6 shadow-md mt-16 sm:mt-[3cm] fade-in">
  <div class="w-full flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">

    <!-- Left: Title + subtitle + active filter -->
    <div>
      <h1 class="text-2xl font-bold tracking-tight">
        Feedback Management
      </h1>

      <p class="mt-1 text-xs sm:text-sm text-blue-100/90 max-w-2xl leading-relaxed">
        Centralized workspace for reviewing, filtering, and exporting user-submitted feedback.
        Each record includes a verified email address, rating, detailed comments, and contextual metadata.
      </p>

      {% if rating_filter %}
        <p class="mt-2 text-xs text-emerald-100/95 flex items-center gap-1.5">
          <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-emerald-500/20 border border-emerald-300/70 text-[0.7rem]">
            Showing entries rated {{ rating_filter }} ★
          </span>
          <a href="{{ url_for('admin_feedback') }}"
             class="text-sky-100 hover:underline text-[0.7rem]">
            Clear filter
          </a>
        </p>
      {% endif %}
    </div>

    <!-- Right: Actions + Rating Filter -->
    <div class="flex flex-col sm:items-end gap-2 text-xs sm:text-sm">

      <!-- Top-right actions -->
      <div class="flex flex-wrap items-center gap-2">
        <a href="{{ url_for('admin_dashboard', page=1) }}"
           class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full border border-blue-300/70 text-blue-50 text-xs hover:bg-blue-800/80 transition">
          <i data-lucide="arrow-left" class="w-3.5 h-3.5"></i>
          Back to Admin Dashboard
        </a>

        <!-- Export button -->
        <a href="{{ url_for('export_feedback_csv', rating=rating_filter) }}"
           class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full border border-emerald-300/70 bg-emerald-500/20 text-xs sm:text-sm text-emerald-50 hover:bg-emerald-400/25 transition">
          <i data-lucide="download" class="w-3.5 h-3.5"></i>
          Export Feedback CSV
        </a>
      </div>

      <!-- Rating filter form -->
      <form method="get"
            action="{{ url_for('admin_feedback') }}"
            class="flex flex-wrap items-center gap-1.5 mt-1">
        <label for="rating" class="text-[0.7rem] text-blue-100/90">
          Filter by rating:
        </label>
        <select id="rating"
                name="rating"
                class="text-[0.7rem] bg-blue-950/70 border border-blue-300/70 rounded-full px-2 py-1 text-blue-50 focus:outline-none focus:ring-1 focus:ring-sky-300/80">
          <option value="" {% if not rating_filter %}selected{% endif %}>All</option>
          <option value="5" {% if rating_filter == 5 %}selected{% endif %}>5 ★</option>
          <option value="4" {% if rating_filter == 4 %}selected{% endif %}>4 ★</option>
          <option value="3" {% if rating_filter == 3 %}selected{% endif %}>3 ★</option>
          <option value="2" {% if rating_filter == 2 %}selected{% endif %}>2 ★</option>
          <option value="1" {% if rating_filter == 1 %}selected{% endif %}>1 ★</option>
        </select>
        <button type="submit"
                class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full border border-blue-300/80 bg-blue-800/80 text-[0.7rem] text-blue-50 hover:bg-blue-700/90 transition">
          Apply
        </button>
      </form>
    </div>
  </div>
</div>

<!-- Main content wrapper -->
<div class="w-full mx-auto text-left space-y-6 sm:space-y-8 px-4 sm:px-6 pt-4 sm:pt-6">

  <!-- Summary pills with floating + count-up -->
  <section class="grid gap-3 sm:grid-cols-3">
    <!-- Total Feedback -->
    <div class="rounded-xl border border-emerald-500/30 bg-emerald-500/10 px-3.5 py-3 feedback-float"
         data-feedback-stat-card>
      <p class="text-xs text-emerald-100/80">Total Feedback</p>
      <p class="mt-1 text-xl font-semibold text-emerald-200"
         data-feedback-stat-value
         data-target="{{ total_feedback or 0 }}">
        0
      </p>
    </div>

    <!-- Registrations -->
    <div class="rounded-xl border border-blue-500/30 bg-blue-500/10 px-3.5 py-3 feedback-float feedback-float-delay-1"
         data-feedback-stat-card>
      <p class="text-xs text-blue-100/80">Registrations</p>
      <p class="mt-1 text-xl font-semibold text-blue-200"
         data-feedback-stat-value
         data-target="{{ stats.registrations if stats and stats.registrations is not none else 0 }}">
        0
      </p>
    </div>

    <!-- Traced searches -->
    <div class="rounded-xl border border-violet-500/30 bg-violet-500/10 px-3.5 py-3 feedback-float feedback-float-delay-2"
         data-feedback-stat-card>
      <p class="text-xs text-violet-100/80">Face Searches (Traced)</p>
      <p class="mt-1 text-xl font-semibold text-violet-200"
         data-feedback-stat-value
         data-target="{{ stats.searches_traced if stats and stats.searches_traced is not none else 0 }}">
        0
      </p>
    </div>
  </section>

  <!-- Feedback table -->
  <section class="mt-2">
    {% if feedback_items %}
      <div class="overflow-x-auto -mx-2 sm:mx-0">
        <div class="inline-block min-w-full align-middle px-2 sm:px-0">
          <div class="overflow-hidden rounded-2xl border border-slate-700 bg-slate-900/70 shadow-lg shadow-black/40">
            <table class="min-w-full text-left text-xs sm:text-sm text-slate-100/90">
              <thead class="bg-slate-900/90 border-b border-slate-700/80">
                <tr>
                  <th class="px-3 sm:px-4 py-2.5 font-medium text-slate-300/90">#</th>
                  <th class="px-3 sm:px-4 py-2.5 font-medium text-slate-300/90">User</th>
                  <th class="px-3 sm:px-4 py-2.5 font-medium text-slate-300/90">Rating</th>
                  <th class="px-3 sm:px-4 py-2.5 font-medium text-slate-300/90">Feedback</th>
                  <th class="px-3 sm:px-4 py-2.5 font-medium text-slate-300/90 hidden lg:table-cell">Context</th>
                  <th class="px-3 sm:px-4 py-2.5 font-medium text-slate-300/90">Date</th>
                  {% if is_super_admin %}
                    <th class="px-3 sm:px-4 py-2.5 font-medium text-slate-300/90 text-right">Actions</th>
                  {% endif %}
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-700/80">
                {% for fb in feedback_items %}
                  <tr class="hover:bg-slate-800/70">
                    <!-- ID -->
                    <td class="px-3 sm:px-4 py-2 align-top text-[0.7rem] sm:text-xs text-slate-400">
                      {{ fb.id }}
                    </td>

                    <!-- User -->
                    <td class="px-3 sm:px-4 py-2 align-top">
                      <div class="space-y-0.5">
                        <p class="text-[0.75rem] sm:text-sm font-medium text-slate-50 flex items-center gap-1">
                          {% if fb.name %}
                            {{ fb.name }}
                          {% else %}
                            <span class="italic text-slate-300/80">Anonymous</span>
                          {% endif %}
                        </p>
                        <p class="text-[0.7rem] text-slate-300/80 break-all">
                          {{ fb.email }}
                        </p>
                        {% if fb.ip_address %}
                          <p class="text-[0.65rem] text-slate-400/80 mt-0.5">
                            IP: {{ fb.ip_address }}
                          </p>
                        {% endif %}
                      </div>
                    </td>

                    <!-- Rating -->
                    <td class="px-3 sm:px-4 py-2 align-top">
                      <div class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-[0.7rem]
                        {% if fb.rating >= 4 %}
                          bg-emerald-500/15 border border-emerald-400/40 text-emerald-200
                        {% elif fb.rating == 3 %}
                          bg-amber-500/15 border border-amber-400/40 text-amber-200
                        {% else %}
                          bg-rose-500/15 border border-rose-400/40 text-rose-200
                        {% endif %}
                      ">
                        <span>{{ fb.rating }}/5</span>
                        <span class="text-xs">⭐</span>
                      </div>
                    </td>

                    <!-- Message -->
                    <td class="px-3 sm:px-4 py-2 align-top max-w-xs sm:max-w-sm">
                      <div class="text-[0.7rem] sm:text-xs text-slate-100/90 whitespace-pre-wrap break-words">
                        {{ fb.message }}
                      </div>
                    </td>

                    <!-- Context (page, UA) - large screens only-->
                    <td class="px-3 sm:px-4 py-2 align-top hidden lg:table-cell max-w-sm">
                      <div class="space-y-1 text-[0.68rem] text-slate-300/85">
                        {% if fb.page_url %}
                          <p>
                            <span class="font-semibold text-slate-200">Page:</span>
                            <a href="{{ fb.page_url }}" target="_blank" rel="noopener noreferrer"
                               class="text-sky-300 hover:underline break-all">
                              {{ fb.page_url }}
                            </a>
                          </p>
                        {% endif %}
                        {% if fb.user_agent %}
                          <p class="text-[0.65rem] text-slate-400/90">
                            <span class="font-semibold text-slate-300/90">UA:</span>
                            {{ fb.user_agent }}
                          </p>
                        {% endif %}
                      </div>
                    </td>

                    <!-- Date -->
                    <td class="px-3 sm:px-4 py-2 align-top text-[0.7rem] text-slate-300/80 whitespace-nowrap">
                      {% if fb.created_at %}
                        {{ fb.created_at.strftime("%Y-%m-%d") }}<br>
                        <span class="text-[0.65rem] text-slate-400">
                          {{ fb.created_at.strftime("%H:%M") }}
                        </span>
                      {% endif %}
                    </td>

                    <!-- Actions (super admin only) -->
                    {% if is_super_admin %}
                      <td class="px-3 sm:px-4 py-2 align-top text-right">
                        <form method="post"
                              action="{{ url_for('admin_delete_feedback', feedback_id=fb.id) }}"
                              onsubmit="return confirm('Delete this feedback permanently?');"
                              class="inline-block">
                          <input type="hidden" name="page" value="{{ current_page }}">
                          <input type="hidden" name="rating" value="{{ rating_filter or '' }}">
                          <button type="submit"
                                  class="inline-flex items-center justify-center w-7 h-7 rounded-full border border-rose-500/60 bg-rose-500/15 text-rose-100 hover:bg-rose-500/30 transition"
                                  title="Delete feedback">
                            <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                          </button>
                        </form>
                      </td>
                    {% endif %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          {% if total_pages > 1 %}
            <div class="mt-3 flex flex-wrap items-center justify-between gap-2 text-[0.75rem] text-slate-300/90">
              <div>
                Page {{ current_page }} of {{ total_pages }}
              </div>
              <div class="flex flex-wrap items-center gap-1.5">
                {% if feedback_pagination.has_prev %}
                  <a href="{{ url_for('admin_feedback', page=feedback_pagination.prev_num, rating=rating_filter) }}"
                     class="inline-flex items-center px-2.5 py-1 rounded-full border border-slate-600/80 text-slate-100 hover:bg-slate-800/70">
                    <i data-lucide="chevron-left" class="w-3.5 h-3.5 mr-0.5"></i>
                    Prev
                  </a>
                {% else %}
                  <span class="inline-flex items-center px-2.5 py-1 rounded-full border border-slate-700/60 text-slate-500/80 cursor-not-allowed">
                    <i data-lucide="chevron-left" class="w-3.5 h-3.5 mr-0.5"></i>
                    Prev
                  </span>
                {% endif %}

                {% if feedback_pagination.has_next %}
                  <a href="{{ url_for('admin_feedback', page=feedback_pagination.next_num, rating=rating_filter) }}"
                     class="inline-flex items-center px-2.5 py-1 rounded-full border border-slate-600/80 text-slate-100 hover:bg-slate-800/70">
                    Next
                    <i data-lucide="chevron-right" class="w-3.5 h-3.5 ml-0.5"></i>
                  </a>
                {% else %}
                  <span class="inline-flex items-center px-2.5 py-1 rounded-full border border-slate-700/60 text-slate-500/80 cursor-not-allowed">
                    Next
                    <i data-lucide="chevron-right" class="w-3.5 h-3.5 ml-0.5"></i>
                  </span>
                {% endif %}
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    {% else %}
      <div class="mt-4 rounded-2xl border border-slate-700/80 bg-slate-900/70 px-4 py-6 text-center text-sm text-slate-300/90">
        <p class="flex flex-col items-center gap-2">
          <i data-lucide="inbox" class="w-6 h-6 text-slate-400"></i>
          <span>No feedback has been submitted yet.</span>
        </p>
        <p class="mt-1 text-xs text-slate-400/90">
          Once users start submitting feedback through the footer form, it will appear here.
        </p>
      </div>
    {% endif %}
  </section>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    if (window.lucide) {
      window.lucide.createIcons();
    }

    // Floating + Count-up on scroll for feedback stats
    document.addEventListener('DOMContentLoaded', () => {
      const statCards = document.querySelectorAll('[data-feedback-stat-card]');

      if (!('IntersectionObserver' in window) || !statCards.length) {
        // Fallback: just set the numbers immediately
        document.querySelectorAll('[data-feedback-stat-value]').forEach(el => {
          const target = parseInt(el.getAttribute('data-target') || '0', 10);
          el.textContent = target.toLocaleString();
        });
        return;
      }

      const animateValue = (el) => {
        const target = parseInt(el.getAttribute('data-target') || '0', 10);
        const duration = 900; // ms
        const start = performance.now();

        const tick = (now) => {
          const progress = Math.min((now - start) / duration, 1);
          const value = Math.floor(progress * target);
          el.textContent = value.toLocaleString();
          if (progress < 1) requestAnimationFrame(tick);
        };

        // Reset to 0 before each run
        el.textContent = '0';
        requestAnimationFrame(tick);
      };

      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (!entry.isIntersecting) return;

          const card = entry.target;
          const valueEl = card.querySelector('[data-feedback-stat-value]');
          if (!valueEl) return;

          animateValue(valueEl);
        });
      }, {
        threshold: 0.4
      });

      statCards.forEach(card => observer.observe(card));
    });
  </script>

  <style>
    /* Floating animation for feedback stat cards */
    @keyframes feedback-float {
      0%, 100% { transform: translateY(0); }
      50%      { transform: translateY(-4px); }
    }

    .feedback-float {
      animation: feedback-float 3s ease-in-out infinite;
    }

    .feedback-float-delay-1 {
      animation-delay: .15s;
    }

    .feedback-float-delay-2 {
      animation-delay: .3s;
    }
  </style>
{% endblock %}
