{% extends "base.html" %}

{% block title %}Search - PersonFinder{% endblock %}

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div id="flash-container" class="fixed left-1/2 top-4 transform -translate-x-1/2 space-y-3 z-[1201] text-center w-[90%] max-w-xl">
      {% for category, message in messages %}
        {% set color = 
          'bg-green-100 border-green-500 text-green-800' if category=='success' else
          'bg-red-100 border-red-500 text-red-800' if category=='error' else
          'bg-yellow-100 border-yellow-500 text-yellow-800'
        %}
        <div class="flash-message relative border-l-4 {{ color }} p-4 rounded-lg shadow-xl transition-opacity duration-1000 pointer-events-auto animate-slide-down" role="alert">
          <p class="font-medium">{{ message }}</p>
          <button onclick="this.parentElement.remove()" class="absolute top-2 right-3 text-lg font-bold hover:opacity-70">&times;</button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

{% block content %}
<div class="flex flex-col items-center w-full px-4 sm:px-6 lg:px-8 py-8 space-y-6 animate-page-enter mt-20">

  <!-- Heading -->
  <div class="text-center w-full mb-[1cm]">
    <h2 class="text-3xl md:text-4xl font-bold text-white mb-1">
      Search for a Missing Person
    </h2>
    <p class="mx-auto text-base sm:text-lg md:text-xl text-center">
      Upload a photo to see if your loved one is in the 
      <span class="bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 bg-clip-text text-transparent font-semibold">
        PersonFinder
      </span> database.
    </p>
  </div>

  <!-- Modern Divider -->
  <div class="relative w-full flex justify-center my-[1cm]">
    <div class="h-px w-3/4 sm:w-2/3 lg:w-1/2 bg-gradient-to-r from-transparent via-gray-400/40 to-transparent"></div>
    <span class="absolute -top-3 bg-blue-900 text-gray-200 text-xs sm:text-sm px-3 py-1 rounded-full shadow-md tracking-wide">
      Search Now
    </span>
  </div>

  <!-- Info Box -->
  <div class="bg-indigo-900/40 border border-indigo-500/30 rounded-xl p-4 shadow-lg max-w-2xl mx-auto text-center mb-[1cm]">
    <p class="text-sm sm:text-base text-gray-200">
      ✨ If you <span class="text-green-300 font-semibold">find someone</span>, please upload their photo 
      to help us <span class="text-purple-300 font-semibold">reunite families</span>.
    </p>
  </div>

  <!-- Search Form -->
  <form method="POST" enctype="multipart/form-data"
        class="w-full max-w-md space-y-6"
        onsubmit="return validatePhoto()">

    <div class="bg-white/5 backdrop-blur-sm p-6 rounded-2xl shadow-xl flex flex-col items-center space-y-4">

      <!-- File Upload -->
      <input type="file" id="photo" name="photo" accept="image/*"
             class="hidden" required onchange="previewPhoto(event)"/>
      <label for="photo"
             class="cursor-pointer px-4 py-2 rounded-lg bg-gradient-to-r from-blue-500 via-cyan-500 to-teal-500 
                    hover:from-teal-500 hover:via-cyan-500 hover:to-blue-500 text-white font-medium shadow-md 
                    transition transform hover:scale-105">
        Upload Photo <span class="text-red-400">*</span>
      </label>

      <!-- Photo Preview -->
      <div id="photo_preview_container" class="hidden w-full flex justify-center mt-4 relative">
        <img id="photo_preview" alt="Photo Preview"
             class="max-h-56 rounded-xl shadow-md border border-gray-500/30 object-contain"/>
        <button type="button" onclick="clearPhoto()"
                class="absolute top-2 right-2 bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded-md shadow-md">✕</button>
      </div>

      <div class="w-full border-t border-white-600 my-4"></div>

      <!-- Optional Name -->
      <div class="w-full">
        <label for="full_name" class="block font-medium mb-1 text-gray-200 text-sm">
          Full Name <span class="text-gray-400 italic">(optional but helpful)</span>
        </label>
        <input type="text" id="full_name" name="full_name" placeholder="e.g. John Doe"
               class="w-full px-4 py-2 rounded-xl bg-white/10 text-white border border-gray-500/30 
                      focus:ring-2 focus:ring-purple-500 focus:outline-none"/>
      </div>

      <div class="w-full border-t border-white-600 my-4"></div>

      <!-- Submit -->
      <button type="submit"
              class="w-full px-6 py-3 rounded-xl text-white font-semibold text-lg shadow-lg 
                     transform transition hover:scale-105 duration-300 search-shimmer">
        Search
      </button>
    </div>
  </form>

  <!-- Results -->
  {% if results %}
    <div id="results_section" class="mt-10 w-full max-w-6xl">
      <h3 class="text-2xl font-bold text-center text-green-400 mb-6">✅ Matches Found</h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">

        {% for person in results %}
          <div class="p-4 rounded-xl backdrop-blur-lg shadow-lg fade-slide-up tilt-card"
               style="animation-delay: {{ loop.index0 * 0.2 }}s;">

            <!-- Person Image -->
            <div class="w-28 h-28 sm:w-32 sm:h-32 mx-auto rounded-xl shadow-md overflow-hidden border
                        {% if loop.first %} border-green-400 {% else %} border-white/20 {% endif %}">
              {% set photo_name = person.photo_path.split('/')[-1] if person.photo_path else '' %}
              <img src="{{ url_for('static', filename='uploads/' ~ photo_name) if photo_name else url_for('static', filename='images/no-photo.png') }}"
                   alt="Person Photo"
                   class="w-full h-full object-cover"
                   onerror="this.src='{{ url_for('static', filename='images/no-photo.png') }}';"/>
            </div>

            <!-- Info -->
            <div class="mt-4 text-sm sm:text-base space-y-2 text-gray-100 text-center">
              {% if loop.first %}
                <p class="text-green-300 font-bold">🎯 Best Match</p>
              {% endif %}
              {% if person.full_name %}<p><span class="font-semibold">Full Name:</span> {{ person.full_name }}</p>{% endif %}
              {% if person.age %}<p><span class="font-semibold">Age:</span> {{ person.age }}</p>{% endif %}
              {% if person.gender %}<p><span class="font-semibold">Gender:</span> {{ person.gender }}</p>{% endif %}
              {% if person.guardian_name %}<p><span class="font-semibold">Guardian:</span> {{ person.guardian_name }}</p>{% endif %}

              {% if person.phone_number %}
                <div class="mt-2 flex flex-col sm:flex-row gap-2 justify-center">
                  <a href="tel:{{ person.phone_number }}"
                     class="inline-flex sm:hidden items-center justify-center px-4 py-2 rounded-xl bg-green-600 hover:bg-green-700 text-white font-medium shadow-md transition-transform transform hover:scale-105">
                    📞 Call
                  </a>
                  <button type="button" onclick="copyPhoneNumber('{{ person.phone_number }}')"
                          class="hidden sm:inline-flex items-center justify-center px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-medium shadow-md transition-transform transform hover:scale-105">
                    📋 Copy Guardian Phone Number
                  </button>
                </div>
              {% endif %}

              {% if person.address %}<p><span class="font-semibold">Address:</span> {{ person.address }}</p>{% endif %}
              {% if person.last_seen %}<p><span class="font-semibold">Last Seen:</span> {{ person.last_seen }}</p>{% endif %}

              {% if person.match_confidence %}
                <p class="font-semibold">Match Confidence:</p>
                <div class="w-full bg-gray-700 rounded-full h-3 overflow-hidden">
                  <div class="h-3 rounded-full"
                       style="width: {{ person.match_confidence }}%;
                              background: {% if person.match_confidence >= 75 %}linear-gradient(to right, #4ade80, #22c55e){% elif person.match_confidence >= 50 %}linear-gradient(to right, #facc15, #f59e0b){% else %}linear-gradient(to right, #f87171, #ef4444){% endif %};">
                  </div>
                </div>
                <p class="text-sm text-gray-300 mt-1">{{ person.match_confidence }}%</p>
              {% endif %}

              <!-- Role-based Delete Button -->
              {% if current_user.is_authenticated %}
                {% if current_user.role == 'admin' or (current_user.role == 'family' and person.created_by == current_user.id) %}
                  <form method="POST" action="{{ url_for('delete', person_id=person.id) }}" class="mt-3">
                    <button type="submit"
                            onclick="return confirm('Are you sure you want to delete this record?')"
                            class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white shadow-md transition-transform transform hover:scale-105">
                      🗑 Delete Record
                    </button>
                  </form>
                {% endif %}
              {% endif %}

              <!-- Registered By -->
              <p class="mt-3 text-xs text-gray-400 italic">📌 Registered by: {{ person.creator.role if person.creator else 'Unknown' }}</p>
            </div>
          </div>
        {% endfor %}

      </div>
    </div>

    {% if results[0] %}
    <script>
      if ("Notification" in window && Notification.permission === "granted") {
        navigator.serviceWorker.getRegistration().then(reg => {
          if (reg) {
            reg.showNotification("🎯 Best Match Found!", {
              body: "A match was found for your search: {{ results[0].full_name or 'Unknown' }}",
              icon: "{{ url_for('static', filename='images/bell-icon.png') }}"
            });
          }
        });
      }
    </script>
    {% endif %}

  {% elif searched %}
    <p id="results_section" class="text-center text-red-400 font-semibold mt-6">⚠ No matches found.</p>
  {% endif %}

</div>

<!-- Scripts -->
<script>
function previewPhoto(event) {
  const previewContainer = document.getElementById('photo_preview_container');
  const preview = document.getElementById('photo_preview');
  const file = event.target.files[0];
  if (file) {
    preview.src = URL.createObjectURL(file);
    previewContainer.classList.remove('hidden');
  }
}
function clearPhoto() {
  document.getElementById('photo').value = "";
  document.getElementById('photo_preview_container').classList.add('hidden');
}
function validatePhoto() {
  if (!document.getElementById('photo').files.length) {
    alert("Please upload a photo before searching.");
    return false;
  }
  return true;
}
function copyPhoneNumber(number) {
  navigator.clipboard.writeText(number).then(() => {
    alert("✅ Phone number copied to clipboard!");
  }).catch(() => {
    alert("❌ Failed to copy phone number.");
  });
}
window.onload = function() {
  const resultsSection = document.getElementById('results_section');
  if (resultsSection) {
    const yOffset = -20;
    const y = resultsSection.getBoundingClientRect().top + window.pageYOffset + yOffset;
    window.scrollTo({ top: y, behavior: 'smooth' });
  }
};
</script>

<!-- Styles -->
<style>
.fade-slide-up { opacity: 0; transform: translateY(40px); animation: slideUp 0.7s ease forwards; }
@keyframes slideUp { to { opacity: 1; transform: translateY(0); } }
.tilt-card { transform-style: preserve-3d; transition: transform 0.3s ease, box-shadow 0.3s ease; }
.tilt-card:hover { transform: scale(1.1) rotateX(5deg) rotateY(5deg); box-shadow: 0 12px 30px rgba(0,0,0,0.4); }
.search-shimmer { position: relative; overflow: hidden; background: linear-gradient(to right, #ef4444, #f87171, #fca5a5); }
.search-shimmer::after {
  content: ""; position: absolute; top: 0; left: -150%; width: 50%; height: 100%;
  background: linear-gradient(120deg, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0) 100%);
  transform: skewX(-20deg); animation: shimmer-slide 2s infinite linear; pointer-events: none;
}
@keyframes shimmer-slide { 0% { left: -150%; } 100% { left: 150%; } }
</style>
{% endblock %}
