{% extends "base.html" %}
{% block title %}Search for a Person{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
  <!-- Header & Description -->
  <div class="text-center mb-8">
    <h1 class="text-3xl font-bold mb-2">Search for a Person</h1>
    <p class="text-gray-300 text-lg">
      Upload a photo to search for a missing person using AI-powered face recognition.
    </p>
  </div>

  <!-- Search Form -->
  <form method="POST" enctype="multipart/form-data" class="max-w-xl mx-auto space-y-6">
    {{ form.hidden_tag() }}

    <!-- Last Seen Field -->
    <div>
      {{ form.last_seen.label(class="block text-white font-semibold mb-1") }}
      {{ form.last_seen(class="w-full px-4 py-2 rounded-lg bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-blue-400") }}
    </div>

    <!-- Photo Upload -->
    <div>
      {{ form.photo.label(class="block text-white font-semibold mb-1") }}
      {{ form.photo(class="w-full text-white") }}
    </div>

    <!-- Webcam Button -->
    <div class="flex justify-center mt-4">
      <button type="button" id="open-webcam"
        class="hidden sm:block bg-gradient-to-r from-green-500 to-emerald-500 text-white px-6 py-2 rounded-full shadow-md hover:from-green-600 hover:to-emerald-600 transition">
        Use Webcam
      </button>
    </div>

    <!-- Webcam Stream -->
    <div id="webcam-container" class="hidden flex flex-col items-center mt-4">
      <video id="webcam" autoplay class="rounded-lg shadow-lg mb-4 w-full max-w-md"></video>
      <button type="button" id="capture-photo" class="px-6 py-3 bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-full shadow-lg hover:scale-105 transform transition-all duration-300">
        Capture Photo
      </button>
    </div>

    <!-- Preview & Clear -->
    <div class="w-full flex flex-col items-center mt-4" id="preview-container">
      <img alt="Uploaded photo preview" 
           class="max-h-64 rounded-lg shadow-md mb-4 hidden transition-transform duration-300 ease-in-out hover:scale-105" 
           id="preview-image" />
      <button class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg shadow-md transition hidden" 
              id="clear-photo-btn" 
              type="button">
        Clear Photo
      </button>
    </div>

    <!-- Submit -->
    <div>
      {{ form.submit(class="w-full px-8 py-4 bg-gradient-to-r from-green-400 to-blue-500 text-white font-semibold rounded-full shadow-lg transform transition-all duration-300 hover:scale-105 hover:shadow-2xl") }}
    </div>
  </form>

  <!-- Search Results -->
  {% if matches %}
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mt-8 w-full max-w-6xl mx-auto">
      {% for person in matches %}
      <div class="relative bg-white/20 backdrop-blur-md rounded-2xl shadow-lg p-6 flex flex-col items-center text-white border border-white/30 transition transform hover:scale-105 hover:shadow-2xl">
          
          <!-- Photo -->
          <img src="{{ url_for('static', filename=person['photo_path']) }}" alt="Photo"
               class="w-32 h-32 object-cover rounded-full border-4 border-white/30 mb-4">
          
          <div class="p-4 rounded-xl bg-gray-800/50 backdrop-blur-sm shadow-md 
              transition-all duration-300 hover:shadow-lg hover:shadow-purple-500/20 
              hover:bg-gray-800/70 border border-gray-700/30 group">

              <!-- Full Name -->
              <h2 class="text-lg font-semibold bg-gradient-to-r from-pink-500 via-purple-500 to-blue-500 bg-clip-text text-transparent 
                         mb-2 transition-all duration-300 group-hover:text-white group-hover:bg-none">
                  {{ person.get('full_name') or person.get('name') }}
              </h2>

              <div class="space-y-1.5 divide-y divide-gray-700/40">
                  {% if person.get('guardian_name') or person.get('guardian') %}
                  <p class="text-sm pt-1">
                      <span class="font-semibold text-gray-100 tracking-wide">Guardian:</span>
                      <span class="text-gray-300">{{ person.get('guardian_name') or person.get('guardian') }}</span>
                  </p>
                  {% endif %}
                  {% if person.get('age') %}
                  <p class="text-sm pt-1">
                      <span class="font-semibold text-gray-100 tracking-wide">Age:</span>
                      <span class="text-gray-300">{{ person['age'] }}</span>
                  </p>
                  {% endif %}
                  {% if person.get('phone') %}
                  <p class="text-sm pt-1">
                      <span class="font-semibold text-gray-100 tracking-wide">Phone:</span>
                      <span class="text-gray-300">{{ person['phone'] }}</span>
                  </p>
                  {% endif %}
                  {% if person.get('address') %}
                  <p class="text-sm pt-1">
                      <span class="font-semibold text-gray-100 tracking-wide">Address:</span>
                      <span class="text-gray-300">{{ person['address'] }}</span>
                  </p>
                  {% endif %}
                  {% if person.get('last_seen') %}
                  <p class="text-sm pt-1">
                      <span class="font-semibold text-gray-100 tracking-wide">Last Seen:</span>
                      <span class="text-gray-300 italic">{{ person['last_seen'] }}</span>
                  </p>
                  {% endif %}
              </div>

              <!-- Delete Button -->
              <form method="POST" action="{{ url_for('delete', person_id=person.get('id')) }}" class="mt-4 w-full">
                <input type="password" name="password" placeholder="Admin Password" 
                       class="w-full px-3 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-red-500 mb-2" required>
                <button type="submit" 
                        class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2 rounded-lg shadow-md transition transform hover:scale-105">
                    Delete
                </button>
              </form>

          </div>
      </div>
      {% endfor %}
  </div>
  {% endif %}
</div>

{% endblock %}

{% block scripts %}
<script>
const photoInput = document.getElementById('photo');
const previewImage = document.getElementById('preview-image');
const clearPhotoBtn = document.getElementById('clear-photo-btn');

if (photoInput) {
  photoInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = ev => {
        previewImage.src = ev.target.result;
        previewImage.classList.remove('hidden');
        clearPhotoBtn.classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    }
  });

  clearPhotoBtn.addEventListener('click', () => {
    photoInput.value = "";
    previewImage.src = "";
    previewImage.classList.add('hidden');
    clearPhotoBtn.classList.add('hidden');
  });
}

// Webcam
const webcamContainer = document.getElementById('webcam-container');
const webcam = document.getElementById('webcam');
const openWebcamBtn = document.getElementById('open-webcam');
const capturePhotoBtn = document.getElementById('capture-photo');

if (openWebcamBtn) {
  openWebcamBtn.addEventListener('click', () => {
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => {
        webcam.srcObject = stream;
        webcamContainer.classList.remove('hidden');
      })
      .catch(err => alert('Unable to access webcam.'));
  });
}

if (capturePhotoBtn) {
  capturePhotoBtn.addEventListener('click', () => {
    const canvas = document.createElement('canvas');
    canvas.width = webcam.videoWidth;
    canvas.height = webcam.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(webcam, 0, 0, canvas.width, canvas.height);
    previewImage.src = canvas.toDataURL('image/png');
    previewImage.classList.remove('hidden');
    clearPhotoBtn.classList.remove('hidden');
    webcamContainer.classList.add('hidden');

    // Save webcam image to hidden form input
    let hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = 'webcam_image';
    hiddenInput.value = previewImage.src;
    document.querySelector('form').appendChild(hiddenInput);
  });
}
</script>
{% endblock %}
