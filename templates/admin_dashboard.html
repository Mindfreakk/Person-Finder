{% extends "base.html" %}
{% block title %}Admin Dashboard - PersonFinder{% endblock %}

{% block content %}
<header class="bg-transparent relative z-50 p-6 flex justify-between items-center shadow-md"></header>

<!-- Blue Header -->
<div class="bg-blue-900 text-white p-6 rounded-b-2xl shadow-md w-full flex flex-col sm:flex-row justify-between items-center mt-[3cm]">
  <h1 class="text-2xl font-bold">Admin Dashboard</h1>
  <div class="flex items-center gap-4">
    <span>Hello, {{ current_user.username }}</span>
    <a href="{{ url_for('logout') }}" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded transition-colors">Logout</a>
  </div>
</div>

<div class="min-h-screen text-gray-900">

  <!-- Stats Cards -->
  <section class="p-6 mt-12">
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
      <!-- Total Users -->
      <div class="bg-white text-gray-900 rounded-2xl shadow p-6 flex items-center justify-between transition-transform transform hover:-translate-y-2 hover:shadow-xl animate-float">
        <div>
          <p class="text-gray-500">Total Users</p>
          <p class="text-2xl font-bold" data-target="{{ users|length }}">0</p>
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 15c2.94 0 5.657.955 7.879 2.804M12 3v12m0 0l-3-3m3 3l3-3" />
          </svg>
        </div>
      </div>

      <!-- Registered People -->
      <div class="bg-white text-gray-900 rounded-2xl shadow p-6 flex items-center justify-between transition-transform transform hover:-translate-y-2 hover:shadow-xl animate-float delay-100">
        <div>
          <p class="text-gray-500">Registered People</p>
          <p class="text-2xl font-bold" data-target="{{ stats.get('registrations', 0) }}">0</p>
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
        </div>
      </div>

      <!-- Searches -->
      <div class="bg-white text-gray-900 rounded-2xl shadow p-6 flex items-center justify-between transition-transform transform hover:-translate-y-2 hover:shadow-xl animate-float delay-200">
        <div>
          <p class="text-gray-500">Searches</p>
          <p class="text-2xl font-bold" data-target="{{ stats.get('searches', 0) }}">0</p>
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
      </div>

      <!-- Recent Logs -->
      <div class="bg-white text-gray-900 rounded-2xl shadow p-6 flex items-center justify-between transition-transform transform hover:-translate-y-2 hover:shadow-xl animate-float delay-300">
        <div>
          <p class="text-gray-500">Recent Logs</p>
          <p class="text-2xl font-bold" data-target="{{ search_logs|length }}">0</p>
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 3C7.029 3 3 7.029 3 12s4.029 9 9 9 9-4.029 9-9-4.029-9-9-9z" />
          </svg>
        </div>
      </div>
    </div>
  </section>

  <!-- Divider for People -->
  <div class="relative w-full flex justify-center my-10">
    <div class="h-px w-3/4 sm:w-2/3 bg-gradient-to-r from-transparent via-gray-400/40 to-transparent"></div>
    <span class="absolute -top-3 bg-blue-900 text-white text-xs sm:text-sm px-3 py-1 rounded-full shadow-md tracking-wide">People</span>
  </div>

  <!-- People Table -->
  <section class="p-6">
    <form id="multiDeleteForm" method="POST" action="{{ url_for('delete_multiple_persons') }}">
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white rounded-2xl shadow overflow-hidden text-gray-700">
          <thead class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
            <tr>
              <th class="py-3 px-6 text-left"><input type="checkbox" id="selectAll" class="form-checkbox h-4 w-4 text-blue-500"/></th>
              <th class="py-3 px-6 text-left">#</th>
              <th class="py-3 px-6 text-left">Photo</th>
              <th class="py-3 px-6 text-left">Full Name</th>
              <th class="py-3 px-6 text-left">Age</th>
              <th class="py-3 px-6 text-left">Gender</th>
              <th class="py-3 px-6 text-left">Guardian</th>
              <th class="py-3 px-6 text-left">Phone Number</th>
              <th class="py-3 px-6 text-left">Last Seen</th>
              <th class="py-3 px-6 text-left">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for person in people %}
            <tr class="border-b border-gray-200 {% if person.is_recent %}bg-green-50{% endif %}">
              <td class="py-3 px-6"><input type="checkbox" name="selected_ids" value="{{ person.id }}" class="form-checkbox h-4 w-4 text-blue-500"/></td>
              <td class="py-3 px-6">{{ loop.index + (page-1)*10 }}</td>
              <td class="py-3 px-6"><img src="{{ url_for('static', filename=person.photo_path) }}" class="h-12 w-12 object-cover rounded-full" alt="Photo"></td>
              <td class="py-3 px-6">{{ person.full_name }}</td>
              <td class="py-3 px-6">{{ person.age }}</td>
              <td class="py-3 px-6">{{ person.gender }}</td>
              <td class="py-3 px-6">{{ person.guardian_name }}</td>
              <td class="py-3 px-6">{{ person.phone_number }}</td>
              <td class="py-3 px-6">{{ person.last_seen }}</td>
              <td class="py-3 px-6 flex gap-2">
                <form method="POST" 
      action="{{ url_for('delete_person', person_id=person.id) }}" 
      class="individualDeleteForm">
  <input type="hidden" name="page" value="{{ page }}">
  <button type="submit" 
          class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded transition-colors">
    Delete
  </button>
</form>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="10" class="text-center py-4 text-gray-500">No records found.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if people|length > 0 %}
      <!-- Delete Selected Floating Card -->
      <div class="bg-white shadow rounded-2xl p-4 mt-6 flex flex-col sm:flex-row justify-between items-center animate-float transition-all duration-700">
        <button type="button" id="deleteSelectedBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded transition-colors">Delete Selected</button>
        <span class="text-gray-700 text-sm sm:text-base mt-2 sm:mt-0">Select multiple people using checkboxes above.</span>
      </div>
      {% endif %}

      <!-- Pagination -->
      {% if total_pages > 1 %}
      <div class="flex justify-center items-center gap-2 mt-6 flex-wrap">
        <a href="{{ url_for('admin_dashboard', page=page-1) }}" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 text-gray-700 {% if page <= 1 %}pointer-events-none opacity-50{% endif %}">Previous</a>
        {% for p in range(1, total_pages+1) %}
        <a href="{{ url_for('admin_dashboard', page=p) }}" class="px-3 py-1 rounded {% if p == page %}bg-blue-500 text-white{% else %}bg-gray-200 hover:bg-gray-300 text-gray-700{% endif %}">{{ p }}</a>
        {% endfor %}
        <a href="{{ url_for('admin_dashboard', page=page+1) }}" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 text-gray-700 {% if page >= total_pages %}pointer-events-none opacity-50{% endif %}">Next</a>
      </div>
      {% endif %}
    </form>
  </section>

  <!-- Divider for Search Logs -->
  <div class="relative w-full flex justify-center my-10">
    <div class="h-px w-3/4 sm:w-2/3 bg-gradient-to-r from-transparent via-gray-400/40 to-transparent"></div>
    <span class="absolute -top-3 bg-blue-900 text-white text-xs sm:text-sm px-3 py-1 rounded-full shadow-md tracking-wide">Search Logs</span>
  </div>

  <!-- Search Logs Table -->
  <section class="p-6">
    <div class="overflow-x-auto">
      <table class="min-w-full bg-white rounded-2xl shadow overflow-hidden text-gray-700">
        <thead class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
          <tr>
            <th class="py-3 px-6 text-left">#</th>
            <th class="py-3 px-6 text-left">Timestamp</th>
            <th class="py-3 px-6 text-left">Searched Name</th>
            <th class="py-3 px-6 text-left">Matches Found</th>
          </tr>
        </thead>
        <tbody>
          {% for log in search_logs %}
          <tr class="border-b border-gray-200">
            <td class="py-3 px-6">{{ loop.index }}</td>
            <td class="py-3 px-6">{{ log.ts.strftime('%Y-%m-%d %H:%M:%S') }}</td>
            <td class="py-3 px-6">{{ log.uploaded_name }}</td>
            <td class="py-3 px-6">{{ log.matches }}</td>
          </tr>
          {% else %}
          <tr>
            <td colspan="4" class="text-center py-4 text-gray-500">No logs available.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if search_logs|length > 0 %}
    <!-- Clear Search Logs Floating Card -->
    <div class="bg-white shadow rounded-2xl p-4 mt-6 flex flex-col sm:flex-row justify-between items-center animate-float transition-all duration-700">
      <button type="button" id="clearLogsBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded transition-colors">
        Clear Search Logs
      </button>
      <span class="text-gray-700 text-sm sm:text-base mt-2 sm:mt-0">This will remove all search history.</span>
    </div>
    {% endif %}

    <!-- Clear Search Logs Modal -->
    <div id="clearLogsModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 opacity-0 transition-opacity duration-300">
      <div class="bg-white rounded-2xl p-6 w-80 max-w-full shadow-lg transform scale-95 transition-transform duration-300">
        <h2 class="text-lg font-semibold mb-4">Confirm Action</h2>
        <p class="mb-6 text-gray-700">Are you sure you want to clear all search logs?</p>
        <div class="flex justify-end gap-3">
          <button id="cancelClearLogs" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 transition-colors">Cancel</button>
          <form method="POST" action="{{ url_for('clear_search_logs') }}">
            <button type="submit" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">Clear Logs</button>
          </form>
        </div>
      </div>
    </div>
  </section>

  <!-- Divider for Users -->
  <div class="relative w-full flex justify-center my-10">
    <div class="h-px w-3/4 sm:w-2/3 bg-gradient-to-r from-transparent via-gray-400/40 to-transparent"></div>
    <span class="absolute -top-3 bg-blue-900 text-white text-xs sm:text-sm px-3 py-1 rounded-full shadow-md tracking-wide">Users</span>
  </div>

  <!-- Users Table -->
  <section class="p-6">
    <div class="overflow-x-auto">
      <table class="min-w-full bg-white rounded-2xl shadow overflow-hidden text-gray-700">
        <thead class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
          <tr>
            <th class="py-3 px-6 text-left">#</th>
            <th class="py-3 px-6 text-left">Username</th>
            <th class="py-3 px-6 text-left">Email</th>
            <th class="py-3 px-6 text-left">Phone Number</th>
            <th class="py-3 px-6 text-left">Role</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr class="border-b border-gray-200">
            <td class="py-3 px-6">{{ loop.index }}</td>
            <td class="py-3 px-6">{{ user.username }}</td>
            <td class="py-3 px-6">{{ user.email }}</td>
            <td class="py-3 px-6">{{ user.phone }}</td>
            <td class="py-3 px-6">{{ user.role }}</td>
          </tr>
          {% else %}
          <tr>
            <td colspan="5" class="text-center py-4 text-gray-500">No users found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 opacity-0 transition-opacity duration-300">
  <div class="bg-white rounded-2xl p-6 w-80 max-w-full shadow-lg transform scale-95 transition-transform duration-300">
    <h2 class="text-lg font-semibold mb-4">Confirm Deletion</h2>
    <p class="mb-6 text-gray-700" id="modalMessage">Are you sure you want to delete?</p>
    <div class="flex justify-end gap-3">
      <button id="cancelDelete" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 transition-colors">Cancel</button>
      <button id="confirmDelete" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">Delete</button>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // --- Count-up animation ---
  const counters = document.querySelectorAll("[data-target]");
  const speed = 40;
  counters.forEach(counter => {
    const updateCount = () => {
      const target = +counter.getAttribute("data-target");
      const count = +counter.innerText;
      const increment = Math.ceil(target / speed);
      if (count < target) {
        counter.innerText = count + increment;
        setTimeout(updateCount, 30);
      } else {
        counter.innerText = target.toLocaleString();
      }
    };
    updateCount();
  });

  // --- Select All checkbox ---
  const selectAll = document.getElementById("selectAll");
  if (selectAll) {
    selectAll.addEventListener("change", function () {
      document.querySelectorAll('input[name="selected_ids"]').forEach(cb => cb.checked = this.checked);
    });
  }

  // --- Delete Modal logic (shared for multi + individual) ---
  const deleteModal = document.getElementById("deleteModal");
  const cancelDelete = document.getElementById("cancelDelete");
  const confirmDelete = document.getElementById("confirmDelete");
  let activeForm = null;

  const openModal = (message, form) => {
    activeForm = form;
    document.getElementById("modalMessage").innerText = message;
    deleteModal.classList.remove("hidden");
    setTimeout(() => {
      deleteModal.classList.remove("opacity-0");
      deleteModal.querySelector("div").classList.remove("scale-95");
    }, 10);
  };

  const closeModal = () => {
    deleteModal.classList.add("opacity-0");
    deleteModal.querySelector("div").classList.add("scale-95");
    setTimeout(() => deleteModal.classList.add("hidden"), 300);
    activeForm = null;
  };

  // Multi delete button
  const multiDeleteForm = document.getElementById("multiDeleteForm");
  const deleteSelectedBtn = document.getElementById("deleteSelectedBtn");
  if (deleteSelectedBtn) {
    deleteSelectedBtn.addEventListener("click", () => {
      const selected = document.querySelectorAll('input[name="selected_ids"]:checked');
      if (selected.length === 0) {
        alert("No people selected.");
        return;
      }
      openModal(`Are you sure you want to delete ${selected.length} selected people?`, multiDeleteForm);
    });
  }

  // Individual delete buttons
  document.querySelectorAll(".individualDeleteForm").forEach(form => {
    form.addEventListener("submit", e => {
      e.preventDefault(); // stop immediate submit
      openModal("Are you sure you want to delete this person?", form);
    });
  });

  // Modal buttons
  if (cancelDelete) cancelDelete.addEventListener("click", closeModal);
  if (confirmDelete) {
    confirmDelete.addEventListener("click", () => {
      if (activeForm) activeForm.submit();
    });
  }

  // --- Clear Logs Modal ---
  const clearLogsBtn = document.getElementById("clearLogsBtn");
  const clearLogsModal = document.getElementById("clearLogsModal");
  const cancelClearLogs = document.getElementById("cancelClearLogs");

  if (clearLogsBtn && clearLogsModal) {
    clearLogsBtn.addEventListener("click", () => {
      clearLogsModal.classList.remove("hidden");
      setTimeout(() => {
        clearLogsModal.classList.remove("opacity-0");
        clearLogsModal.querySelector("div").classList.remove("scale-95");
      }, 10);
    });
  }

  if (cancelClearLogs && clearLogsModal) {
    cancelClearLogs.addEventListener("click", () => {
      clearLogsModal.classList.add("opacity-0");
      clearLogsModal.querySelector("div").classList.add("scale-95");
      setTimeout(() => clearLogsModal.classList.add("hidden"), 300);
    });
  }
});
</script>

<style>
@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-6px); }
}
.animate-float { animation: float 3s ease-in-out infinite; }
.animate-float.delay-100 { animation-delay: 0.1s; }
.animate-float.delay-200 { animation-delay: 0.2s; }
.animate-float.delay-300 { animation-delay: 0.3s; }
</style>

{% endblock %}
