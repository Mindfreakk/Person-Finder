{% extends "base.html" %}
{% block title %}Admin Dashboard - PersonFinder{% endblock %}

{% block content %}
<header class="bg-transparent relative z-50 p-6 flex justify-between items-center shadow-md"></header>

<!-- Full-bleed header -->
<div class="w-full bg-blue-900 text-white p-6 shadow-md mt-16 sm:mt-[3cm] fade-in">
  <div class="w-full flex flex-col sm:flex-row justify-between items-center">
    <h1 class="text-2xl font-bold">Admin Dashboard</h1>
    <div class="flex items-center gap-4 mt-4 sm:mt-0">
      <span>Hello, {{ current_user.username }}</span>
      <a href="{{ url_for('logout') }}" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded transition-colors">Logout</a>
    </div>
  </div>
</div>

<!-- Full-width page wrapper -->
<div class="min-h-screen text-gray-900 w-full">

  <!-- Stats -->
  <section class="w-full p-4 sm:p-6 fade-in delay-100">
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6">
      <div class="bg-white rounded-2xl shadow p-5 flex items-center justify-between animate-float">
        <div>
          <p class="text-gray-500">Total Users</p>
          <p class="text-2xl font-bold" data-target="{{ users|length }}">0</p>
        </div>
        <svg class="h-10 w-10 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 15c2.94 0 5.657.955 7.879 2.804M12 3v12m0 0l-3-3m3 3l3-3"/></svg>
      </div>

      <div class="bg-white rounded-2xl shadow p-5 flex items-center justify-between animate-float delay-100">
        <div>
          <p class="text-gray-500">Registered People</p>
          <p class="text-2xl font-bold" data-target="{{ stats.get('registrations', 0) }}">0</p>
        </div>
        <svg class="h-10 w-10 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
      </div>

      <div class="bg-white rounded-2xl shadow p-5 flex items-center justify-between animate-float delay-200">
        <div>
          <p class="text-gray-500">Searches</p>
          <p class="text-2xl font-bold" data-target="{{ stats.get('searches', 0) }}">0</p>
        </div>
        <svg class="h-10 w-10 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
      </div>

      <div class="bg-white rounded-2xl shadow p-5 flex items-center justify-between animate-float delay-300">
        <div>
          <p class="text-gray-500">Recent Logs</p>
          <p class="text-2xl font-bold" data-target="{{ search_logs|length }}">0</p>
        </div>
        <svg class="h-10 w-10 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 3C7.029 3 3 7.029 3 12s4.029 9 9 9 9-4.029 9-9-4.029-9-9-9z"/></svg>
      </div>
    </div>
  </section>

  <!-- Divider -->
  <div class="relative w-full flex justify-center my-8 fade-in delay-150">
    <div class="h-px w-11/12 bg-gradient-to-r from-transparent via-gray-400/40 to-transparent"></div>
    <span class="absolute -top-3 bg-blue-900 text-white text-xs sm:text-sm px-3 py-1 rounded-full shadow-md tracking-wide">People</span>
  </div>

  <!-- People (Mobile cards) -->
  <section class="w-full px-4 sm:px-6 fade-in delay-200 md:hidden">
    <form id="multiDeleteForm" method="POST" action="{{ url_for('delete_multiple_persons') }}">
      <div class="space-y-3">
        {% for person in people %}
        <div class="bg-white rounded-2xl shadow p-4">
          <div class="flex items-start gap-3">
            <input type="checkbox" name="selected_ids" value="{{ person.id }}" class="mt-1 h-4 w-4 text-blue-500">
            <img src="{{ url_for('static', filename=person.photo_path) }}" class="h-12 w-12 object-cover rounded-full" alt="Photo">
            <div class="flex-1 min-w-0">
              <div class="flex items-center justify-between">
                <h3 class="font-semibold text-gray-900 break-words">{{ person.full_name }}</h3>
                <span class="text-xs text-gray-500">#{{ loop.index + (page-1)*10 }}</span>
              </div>
              <p class="text-xs text-gray-600 mt-1 break-words">
                Age: {{ person.age }} â€¢ {{ person.gender }}
              </p>
              <p class="text-xs text-gray-600 mt-1 break-words">Guardian: {{ person.guardian_name }}</p>
              <p class="text-xs text-gray-600 mt-1 break-all">Phone: {{ person.phone_number }}</p>
              <p class="text-xs text-gray-600 mt-1 break-words">Last seen: {{ person.last_seen }}</p>
              <form method="POST" action="{{ url_for('delete_person', person_id=person.id) }}" class="individualDeleteForm mt-3">
                <input type="hidden" name="page" value="{{ page }}">
                <button type="submit" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded transition-all transform hover:-translate-y-0.5">
                  Delete
                </button>
              </form>
            </div>
          </div>
        </div>
        {% else %}
        <div class="text-center text-gray-500 py-4 bg-white rounded-2xl shadow">No records found.</div>
        {% endfor %}
      </div>

      {% if people|length > 0 %}
      <div class="bg-white shadow rounded-2xl p-4 mt-4 flex flex-col sm:flex-row justify-between items-center fade-in delay-300">
        <button type="button" id="deleteSelectedBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded transition-all transform hover:-translate-y-0.5">Delete Selected</button>
        <span class="text-gray-700 text-sm sm:text-base mt-2 sm:mt-0">Select multiple people using checkboxes above.</span>
      </div>
      {% endif %}
    </form>
  </section>

  <!-- People (Desktop table) -->
  <section class="w-full px-4 sm:px-6 fade-in delay-200 hidden md:block">
    <form id="multiDeleteForm" method="POST" action="{{ url_for('delete_multiple_persons') }}">
      <div class="w-full">
        <table class="w-full table-auto bg-white rounded-2xl shadow text-gray-700 border-separate border-spacing-0">
          <thead class="bg-gray-200 text-gray-600 uppercase text-xs sm:text-sm leading-normal">
            <tr>
              <th class="py-3 px-3 w-10"><input type="checkbox" id="selectAll" class="h-4 w-4 text-blue-500"></th>
              <th class="py-3 px-3 w-12">#</th>
              <th class="py-3 px-3 w-16">Photo</th>
              <th class="py-3 px-3">Full Name</th>
              <th class="py-3 px-3 w-16">Age</th>
              <th class="py-3 px-3 w-24">Gender</th>
              <th class="py-3 px-3">Guardian</th>
              <th class="py-3 px-3">Phone Number</th>
              <th class="py-3 px-3">Last Seen</th>
              <th class="py-3 px-3 w-28">Actions</th>
            </tr>
          </thead>
          <tbody class="text-sm">
            {% for person in people %}
            <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors {% if person.is_recent %}bg-green-50{% endif %}">
              <td class="py-3 px-3">
                <input type="checkbox" name="selected_ids" value="{{ person.id }}" class="h-4 w-4 text-blue-500">
              </td>
              <td class="py-3 px-3">{{ loop.index + (page-1)*10 }}</td>
              <td class="py-3 px-3">
                <img src="{{ url_for('static', filename=person.photo_path) }}" class="h-12 w-12 object-cover rounded-full mx-auto" alt="Photo">
              </td>
              <td class="py-3 px-3 whitespace-normal break-words leading-snug">{{ person.full_name }}</td>
              <td class="py-3 px-3">{{ person.age }}</td>
              <td class="py-3 px-3">{{ person.gender }}</td>
              <td class="py-3 px-3 whitespace-normal break-words">{{ person.guardian_name }}</td>
              <td class="py-3 px-3 whitespace-normal break-all">{{ person.phone_number }}</td>
              <td class="py-3 px-3 whitespace-normal break-words">{{ person.last_seen }}</td>
              <td class="py-3 px-3">
                <form method="POST" action="{{ url_for('delete_person', person_id=person.id) }}" class="individualDeleteForm inline">
                  <input type="hidden" name="page" value="{{ page }}">
                  <button type="submit" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded transition-all transform hover:-translate-y-0.5">
                    Delete
                  </button>
                </form>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="10" class="text-center py-4 text-gray-500">No records found.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if people|length > 0 %}
      <div class="bg-white shadow rounded-2xl p-4 mt-6 flex flex-col sm:flex-row justify-between items-center fade-in delay-300">
        <button type="button" id="deleteSelectedBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded transition-all transform hover:-translate-y-0.5">Delete Selected</button>
        <span class="text-gray-700 text-sm sm:text-base mt-2 sm:mt-0">Select multiple people using checkboxes above.</span>
      </div>
      {% endif %}

      {% if total_pages > 1 %}
      <div class="flex justify-center items-center gap-2 mt-6 flex-wrap fade-in delay-300">
        <a href="{{ url_for('admin_dashboard', page=page-1) }}" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 text-gray-700 {% if page <= 1 %}pointer-events-none opacity-50{% endif %}">Previous</a>
        {% for p in range(1, total_pages+1) %}
          <a href="{{ url_for('admin_dashboard', page=p) }}" class="px-3 py-1 rounded {% if p == page %}bg-blue-500 text-white{% else %}bg-gray-200 hover:bg-gray-300 text-gray-700{% endif %}">{{ p }}</a>
        {% endfor %}
        <a href="{{ url_for('admin_dashboard', page=page+1) }}" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 text-gray-700 {% if page >= total_pages %}pointer-events-none opacity-50{% endif %}">Next</a>
      </div>
      {% endif %}
    </form>
  </section>

  <!-- Divider -->
  <div class="relative w-full flex justify-center my-8 fade-in delay-150">
    <div class="h-px w-11/12 bg-gradient-to-r from-transparent via-gray-400/40 to-transparent"></div>
    <span class="absolute -top-3 bg-blue-900 text-white text-xs sm:text-sm px-3 py-1 rounded-full shadow-md tracking-wide">Search Logs</span>
  </div>

  <!-- Search Logs (Mobile cards) -->
  <section class="w-full px-4 sm:px-6 fade-in delay-200 md:hidden">
    <div class="space-y-3">
      {% for log in search_logs %}
      <div class="bg-white rounded-2xl shadow p-4">
        <div class="flex items-start justify-between">
          <span class="text-xs text-gray-500">#{{ loop.index }}</span>
          <span class="text-xs text-gray-500 break-all">{{ log.ts.strftime('%Y-%m-%d %H:%M:%S') }}</span>
        </div>
        <p class="mt-2 text-sm text-gray-700 break-words"><strong>Name:</strong> {{ log.uploaded_name }}</p>
        <p class="mt-1 text-sm text-gray-700"><strong>Matches:</strong> {{ log.matches }}</p>
      </div>
      {% else %}
      <div class="text-center text-gray-500 py-4 bg-white rounded-2xl shadow">No logs available.</div>
      {% endfor %}
    </div>

    {% if search_logs|length > 0 %}
    <div class="bg-white shadow rounded-2xl p-4 mt-6 flex flex-col sm:flex-row justify-between items-center fade-in delay-300">
      <button type="button" id="clearLogsBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded transition-all transform hover:-translate-y-0.5">
        Clear Search Logs
      </button>
      <span class="text-gray-700 text-sm sm:text-base mt-2 sm:mt-0">This will remove all search history.</span>
    </div>
    {% endif %}
  </section>

  <!-- Search Logs (Desktop table) -->
  <section class="w-full px-4 sm:px-6 fade-in delay-200 hidden md:block">
    <div class="w-full">
      <table class="w-full table-auto bg-white rounded-2xl shadow text-gray-700">
        <thead class="bg-gray-200 text-gray-600 uppercase text-xs sm:text-sm leading-normal">
          <tr>
            <th class="py-3 px-3 w-12">#</th>
            <th class="py-3 px-3 w-[16rem]">Timestamp</th>
            <th class="py-3 px-3">Searched Name</th>
            <th class="py-3 px-3 w-20">Matches</th>
          </tr>
        </thead>
        <tbody class="text-sm">
          {% for log in search_logs %}
          <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
            <td class="py-3 px-3">{{ loop.index }}</td>
            <td class="py-3 px-3 whitespace-normal break-words">{{ log.ts.strftime('%Y-%m-%d %H:%M:%S') }}</td>
            <td class="py-3 px-3 whitespace-normal break-words">{{ log.uploaded_name }}</td>
            <td class="py-3 px-3">{{ log.matches }}</td>
          </tr>
          {% else %}
          <tr>
            <td colspan="4" class="text-center py-4 text-gray-500">No logs available.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if search_logs|length > 0 %}
    <div class="bg-white shadow rounded-2xl p-4 mt-6 flex flex-col sm:flex-row justify-between items-center fade-in delay-300">
      <button type="button" id="clearLogsBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded transition-all transform hover:-translate-y-0.5">
        Clear Search Logs
      </button>
      <span class="text-gray-700 text-sm sm:text-base mt-2 sm:mt-0">This will remove all search history.</span>
    </div>
    {% endif %}

    <!-- Modal -->
    <div id="clearLogsModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 opacity-0 transition-opacity duration-300">
      <div class="bg-white rounded-2xl p-6 w-80 max-w-full shadow-lg transform scale-95 transition-transform duration-300">
        <h2 class="text-lg font-semibold mb-4">Confirm Action</h2>
        <p class="mb-6 text-gray-700">Are you sure you want to clear all search logs?</p>
        <div class="flex justify-end gap-3">
          <button id="cancelClearLogs" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 transition-colors">Cancel</button>
          <form method="POST" action="{{ url_for('clear_search_logs') }}">
            <button type="submit" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">Clear Logs</button>
          </form>
        </div>
      </div>
    </div>
  </section>

  <!-- Divider -->
  <div class="relative w-full flex justify-center my-8 fade-in delay-150">
    <div class="h-px w-11/12 bg-gradient-to-r from-transparent via-gray-400/40 to-transparent"></div>
    <span class="absolute -top-3 bg-blue-900 text-white text-xs sm:text-sm px-3 py-1 rounded-full shadow-md tracking-wide">Users</span>
  </div>

  <!-- Users (Mobile cards) -->
  <section class="w-full px-4 sm:px-6 pb-10 fade-in delay-200 md:hidden">
    <div class="space-y-3">
      {% for user in users %}
      <div class="bg-white rounded-2xl shadow p-4">
        <div class="flex items-start justify-between">
          <h3 class="font-semibold text-gray-900 break-words">{{ user.username }}</h3>
          <span class="text-xs text-gray-500">#{{ loop.index }}</span>
        </div>
        <p class="mt-1 text-sm text-gray-700 break-all">{{ user.email }}</p>
        <p class="mt-1 text-sm text-gray-700 break-all">Phone: {{ user.phone }}</p>
        <p class="mt-1 text-sm text-gray-700">Role: {{ user.role }}</p>
      </div>
      {% else %}
      <div class="text-center text-gray-500 py-4 bg-white rounded-2xl shadow">No users found.</div>
      {% endfor %}
    </div>
  </section>

  <!-- Users (Desktop table) -->
  <section class="w-full px-4 sm:px-6 pb-10 fade-in delay-200 hidden md:block">
    <div class="w-full">
      <table class="w-full table-auto bg-white rounded-2xl shadow text-gray-700">
        <thead class="bg-gray-200 text-gray-600 uppercase text-xs sm:text-sm leading-normal">
          <tr>
            <th class="py-3 px-3 w-12">#</th>
            <th class="py-3 px-3">Username</th>
            <th class="py-3 px-3">Email</th>
            <th class="py-3 px-3 w-[12rem]">Phone</th>
            <th class="py-3 px-3 w-28">Role</th>
          </tr>
        </thead>
        <tbody class="text-sm">
          {% for user in users %}
          <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
            <td class="py-3 px-3">{{ loop.index }}</td>
            <td class="py-3 px-3 whitespace-normal break-words">{{ user.username }}</td>
            <td class="py-3 px-3 whitespace-normal break-all">{{ user.email }}</td>
            <td class="py-3 px-3 whitespace-normal break-all">{{ user.phone }}</td>
            <td class="py-3 px-3 whitespace-normal break-words">{{ user.role }}</td>
          </tr>
          {% else %}
          <tr>
            <td colspan="5" class="text-center py-4 text-gray-500">No users found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 opacity-0 transition-opacity duration-300">
  <div class="bg-white rounded-2xl p-6 w-80 max-w-full shadow-lg transform scale-95 transition-transform duration-300">
    <h2 class="text-lg font-semibold mb-4">Confirm Deletion</h2>
    <p class="mb-6 text-gray-700" id="modalMessage">Are you sure you want to delete?</p>
    <div class="flex justify-end gap-3">
      <button id="cancelDelete" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 transition-colors">Cancel</button>
      <button id="confirmDelete" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">Delete</button>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Count-up
  const counters = document.querySelectorAll("[data-target]");
  counters.forEach(counter => {
    const target = +counter.getAttribute("data-target");
    let count = 0;
    const step = Math.max(1, Math.ceil(target / 40));
    const tick = () => {
      count = Math.min(target, count + step);
      counter.textContent = count.toLocaleString();
      if (count < target) requestAnimationFrame(tick);
    };
    requestAnimationFrame(tick);
  });

  // Select all
  const selectAll = document.getElementById("selectAll");
  if (selectAll) {
    selectAll.addEventListener("change", function () {
      document.querySelectorAll('input[name="selected_ids"]').forEach(cb => cb.checked = this.checked);
    });
  }

  // Delete modals
  const deleteModal = document.getElementById("deleteModal");
  const cancelDelete = document.getElementById("cancelDelete");
  const confirmDelete = document.getElementById("confirmDelete");
  let activeForm = null;

  const openModal = (message, form) => {
    activeForm = form;
    document.getElementById("modalMessage").innerText = message;
    deleteModal.classList.remove("hidden");
    setTimeout(() => {
      deleteModal.classList.remove("opacity-0");
      deleteModal.querySelector("div").classList.remove("scale-95");
    }, 10);
  };
  const closeModal = () => {
    deleteModal.classList.add("opacity-0");
    deleteModal.querySelector("div").classList.add("scale-95");
    setTimeout(() => deleteModal.classList.add("hidden"), 300);
    activeForm = null;
  };

  const multiDeleteForm = document.getElementById("multiDeleteForm");
  const deleteSelectedBtn = document.getElementById("deleteSelectedBtn");
  if (deleteSelectedBtn) {
    deleteSelectedBtn.addEventListener("click", () => {
      const selected = document.querySelectorAll('input[name="selected_ids"]:checked');
      if (selected.length === 0) { alert("No people selected."); return; }
      openModal(`Are you sure you want to delete ${selected.length} selected people?`, multiDeleteForm);
    });
  }
  document.querySelectorAll(".individualDeleteForm").forEach(form => {
    form.addEventListener("submit", e => {
      e.preventDefault();
      openModal("Are you sure you want to delete this person?", form);
    });
  });
  if (cancelDelete) cancelDelete.addEventListener("click", closeModal);
  if (confirmDelete) confirmDelete.addEventListener("click", () => { if (activeForm) activeForm.submit(); });

  // Clear logs modal
  const clearLogsBtn = document.getElementById("clearLogsBtn");
  const clearLogsModal = document.getElementById("clearLogsModal");
  const cancelClearLogs = document.getElementById("cancelClearLogs");
  if (clearLogsBtn && clearLogsModal) {
    clearLogsBtn.addEventListener("click", () => {
      clearLogsModal.classList.remove("hidden");
      setTimeout(() => {
        clearLogsModal.classList.remove("opacity-0");
        clearLogsModal.querySelector("div").classList.remove("scale-95");
      }, 10);
    });
  }
  if (cancelClearLogs && clearLogsModal) {
    cancelClearLogs.addEventListener("click", () => {
      clearLogsModal.classList.add("opacity-0");
      clearLogsModal.querySelector("div").classList.add("scale-95");
      setTimeout(() => clearLogsModal.classList.add("hidden"), 300);
    });
  }
});
</script>

<style>
/* Float (stat cards) */
@keyframes float { 0%,100% { transform: translateY(0) } 50% { transform: translateY(-6px) } }
.animate-float { animation: float 3s ease-in-out infinite; }
.animate-float.delay-100 { animation-delay: .1s; }
.animate-float.delay-200 { animation-delay: .2s; }
.animate-float.delay-300 { animation-delay: .3s; }

/* Section fade-in */
@keyframes fadeInUp { from { opacity: 0; transform: translateY(12px) } to { opacity: 1; transform: translateY(0) } }
.fade-in { opacity: 0; animation: fadeInUp .5s ease-out forwards; }
.fade-in.delay-100 { animation-delay: .1s; }
.fade-in.delay-150 { animation-delay: .15s; }
.fade-in.delay-200 { animation-delay: .2s; }
.fade-in.delay-300 { animation-delay: .3s; }
</style>
{% endblock %}
