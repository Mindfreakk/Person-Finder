{% extends "base.html" %}

{% block title %}Register - PersonFinder{% endblock %}

{% block content %}
<div class="flex flex-col items-center w-full px-4 sm:px-6 lg:px-8 py-10 animate-page-enter mt-20">

  <!-- Heading -->
  <div class="text-center max-w-2xl mx-auto mb-10">
    <h2 class="text-3xl md:text-4xl font-extrabold text-white mb-3">
      Register a Missing Person
    </h2>
    <p class="mx-auto text-xs sm:text-sm md:text-base text-center font-semibold leading-relaxed">
      <span class="text-blue-400">Fill in the details</span>
      <span class="text-purple-400">and upload a photo</span>
      <span class="text-pink-400">to add a person to the database.</span>
      <br>
      <span class="bg-gradient-to-r from-green-400 via-teal-300 to-cyan-400 bg-clip-text text-transparent font-semibold">
        Ensure all information
      </span>
      <span class="bg-gradient-to-r from-green-400 via-teal-300 to-cyan-400 bg-clip-text text-transparent font-semibold">
        provided is accurate
      </span>
      <span class="bg-gradient-to-r from-green-400 via-teal-300 to-cyan-400 bg-clip-text text-transparent font-semibold">
        to assist with proper identification.
      </span>
    </p>

    <!-- Divider: Form -->
    <div class="relative w-full flex justify-center my-8 sm:my-10">
      <div class="h-px w-3/4 sm:w-2/3 lg:w-1/2 bg-gradient-to-r from-transparent via-gray-400/40 to-transparent"></div>
      <span class="absolute -top-3 bg-blue-900 text-gray-200 text-xs sm:text-sm px-3 py-1 rounded-full shadow-md tracking-wide">
        Register Now
      </span>
    </div>
  </div>

  <!-- Registration Form -->
  <form method="POST" enctype="multipart/form-data" class="w-full max-w-2xl space-y-6" id="register_form" novalidate>

    <!-- Card Container -->
    <div class="bg-white/5 backdrop-blur-sm p-6 rounded-2xl shadow-xl flex flex-col animate-card">

      <!-- Section Heading -->
      <h3 class="text-2xl sm:text-3xl font-extrabold text-center mb-6 flex items-center justify-center gap-2 text-gray-200">
        <svg xmlns="http://www.w3.org/2000/svg"
             class="w-7 h-7 text-indigo-400 drop-shadow-sm"
             fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M17 20h5v-2a4 4 0 00-3-3.87M9 20H4v-2a4 4 0 013-3.87
                   M16 11a4 4 0 10-8 0 4 4 0 008 0z" />
        </svg>
        Missing Person Details
      </h3>

      <div class="w-full border-t border-white/20 my-2"></div>

      <!-- Photo Upload -->
      <div class="flex flex-col items-center">
        <!-- file input + hidden base64 input -->
        <input
          type="file"
          id="photo"
          name="photo"
          accept="image/jpeg,image/png,image/webp,image/*"
          class="hidden"
          aria-label="Upload photo of the missing person"
        >
        <input type="hidden" id="photo_input" name="photo_input">

        <!-- Upload + Tooltip + Webcam -->
        <div class="flex flex-col sm:flex-row items-center gap-3 w-full sm:w-auto">
          <div class="flex flex-col items-center gap-2">
            <!-- Upload -->
            <label for="photo" id="upload_label"
                   class="cursor-pointer px-4 py-2 rounded-lg bg-gradient-to-r from-blue-500 via-cyan-500 to-teal-500
                          hover:from-teal-500 hover:via-cyan-500 hover:to-blue-500 text-white font-medium shadow-md
                          transition transform hover:scale-105 w-full text-center">
              Upload Photo <span class="text-red-400">*</span>
            </label>

            <!-- Tooltip Icon (below Upload on mobile, inline on desktop) -->
            <div class="relative flex justify-center sm:hidden">
              <button type="button" id="search_info_btn_mobile"
                      aria-label="Upload/Use Webcam Info"
                      class="h-5 w-5 text-gray-400 hover:text-blue-400 focus:outline-none relative group animate-subtle-bounce">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 16h-1v-4h-1m1-4h.01M12 2a10 10 0 100 20 10 10 0 000-20z"/>
                </svg>

                <!-- Tooltip -->
                <span class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 w-64 sm:w-56 text-xs bg-gray-900 text-white rounded-lg py-2 px-3
                             opacity-0 invisible group-hover:opacity-100 group-hover:visible
                             transition-all duration-300 ease-out
                             transform -translate-y-1 group-hover:translate-y-0 text-center z-50">
                  For optimal results, please upload a high-quality, front-facing photo.
                  <svg class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-3 h-3 text-gray-900" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M0 5 L5 10 L10 5 Z" fill="currentColor"/></svg>
                </span>
              </button>
            </div>
          </div>

          <!-- Tooltip Icon (desktop inline) -->
          <div class="relative hidden sm:flex justify-center">
            <button type="button" id="search_info_btn" aria-label="Upload/Use Webcam Info"
                    class="h-5 w-5 text-gray-400 hover:text-blue-400 focus:outline-none relative group animate-subtle-bounce">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M13 16h-1v-4h-1m1-4h.01M12 2a10 10 0 100 20 10 10 0 000-20z"/>
              </svg>

              <!-- Tooltip -->
              <span class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 w-64 sm:w-56 text-xs bg-gray-900 text-white rounded-lg py-2 px-3
                           opacity-0 invisible group-hover:opacity-100 group-hover:visible
                           transition-all duration-300 ease-out
                           transform -translate-y-1 group-hover:translate-y-0 text-center z-50">
                For optimal results, please upload a high-quality, front-facing photo.
                <svg class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-3 h-3 text-gray-900" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M0 5 L5 10 L10 5 Z" fill="currentColor"/></svg>
              </span>
            </button>
          </div>

          <!-- Webcam -->
          <button type="button" id="use_webcam_btn"
                  class="hidden sm:inline-block px-4 py-2 rounded-lg bg-gradient-to-r from-violet-500 to-fuchsia-500
                         hover:from-fuchsia-500 hover:to-violet-500 text-white font-medium shadow-md
                         transition transform hover:scale-105">
            Use Webcam
          </button>
        </div>

        <!-- Webcam Area -->
        <div id="webcam_container" class="hidden mt-4 w-full max-w-md rounded-xl border border-white/20 p-3 bg-white/5">
          <video id="webcam" autoplay playsinline class="w-full rounded-lg bg-black"></video>
          <div class="mt-3 flex gap-3 justify-center">
            <button type="button" id="capture_btn"
                    class="px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white shadow">
              Capture
            </button>
            <button type="button" id="close_webcam_btn"
                    class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white shadow">
              Close
            </button>
          </div>
        </div>

        <!-- Photo Preview -->
        <div id="photo_preview_container" class="hidden w-full flex justify-center mt-4 relative">
          <img id="photo_preview" alt="Photo Preview"
               class="max-h-56 rounded-xl shadow-md border border-gray-500/30 object-contain"/>
          <button type="button" onclick="clearPhoto()"
                  class="absolute top-2 right-2 bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded-md shadow-md">
            ‚úï
          </button>
          <span id="photo_check" class="hidden absolute top-2 left-2 text-green-500 text-2xl font-bold">‚úî</span>
        </div>

        <!-- Error Message -->
        <p id="photo_error" class="text-red-400 text-sm mt-2 hidden" role="alert">
          Photo is required (upload a file or capture from webcam).
        </p>
      </div>

      <div class="w-full border-t border-white/20 my-2"></div>

      <!-- Person Details -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Full Name -->
        <div class="relative">
          <label for="full_name" class="block font-medium mb-1 text-gray-200">Full Name</label>
          <input type="text" id="full_name" name="full_name" placeholder="e.g. John Doe" required
                 class="w-full px-4 py-2 rounded-xl bg-white/10 text-white border border-gray-500/30
                        focus:ring-2 focus:ring-purple-500 focus:outline-none"/>
          <span id="full_name_check" class="hidden absolute right-3 top-[46px] -translate-y-1/2 text-green-500 text-xl font-bold">‚úî</span>
          <p id="full_name_error" class="text-red-400 text-xs mt-1 hidden">Full name is required.</p>
        </div>

        <!-- Age -->
        <div class="relative">
          <label for="age" class="block font-medium mb-1 text-gray-200">Age</label>
          <input type="number" id="age" name="age" placeholder="e.g. 30" required
                 class="w-full px-4 py-2 rounded-xl bg-white/10 text-white border border-gray-500/30
                        focus:ring-2 focus:ring-purple-500 focus:outline-none"/>
          <span id="age_check" class="hidden absolute right-3 top-[46px] -translate-y-1/2 text-green-500 text-xl font-bold">‚úî</span>
          <p id="age_error" class="text-red-400 text-xs mt-1 hidden">Age is required.</p>
        </div>

        <!-- Gender -->
        <div class="relative">
          <label for="gender" class="block font-medium mb-1 text-gray-200">Gender</label>
          <div class="relative">
            <select id="gender" name="gender" required
                    class="w-full appearance-none px-4 py-2 rounded-xl bg-white/10 text-white border border-gray-500/30
                           focus:ring-2 focus:ring-purple-500 focus:outline-none">
              <option value="">Select</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
              <option value="Other">Other</option>
            </select>
            <span class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400">‚ñº</span>
          </div>
          <span id="gender_check" class="hidden absolute right-3 top-[46px] -translate-y-1/2 text-green-500 text-xl font-bold">‚úî</span>
          <p id="gender_error" class="text-red-400 text-xs mt-1 hidden">Please select a gender.</p>
        </div>

        <!-- Guardian Name -->
        <div class="relative">
          <label for="guardian_name" class="block font-medium mb-1 text-gray-200">Guardian Name</label>
          <input type="text" id="guardian_name" name="guardian_name" placeholder="e.g. Jane Doe" required
                 class="w-full px-4 py-2 rounded-xl bg-white/10 text-white border border-gray-500/30
                        focus:ring-2 focus:ring-purple-500 focus:outline-none"/>
          <span id="guardian_name_check" class="hidden absolute right-3 top-[46px] -translate-y-1/2 text-green-500 text-xl font-bold">‚úî</span>
          <p id="guardian_name_error" class="text-red-400 text-xs mt-1 hidden">Guardian name is required.</p>
        </div>

        <!-- Guardian Phone -->
        <div class="relative">
          <label for="phone_number" class="block font-medium mb-1 text-gray-200">Guardian Phone</label>
          <input type="text" id="phone_number" name="phone_number" placeholder="e.g. +1234567890" required
                 class="w-full px-4 py-2 rounded-xl bg-white/10 text-white border border-gray-500/30
                        focus:ring-2 focus:ring-purple-500 focus:outline-none"/>
          <span id="phone_number_check" class="hidden absolute right-3 top-[46px] -translate-y-1/2 text-green-500 text-xl font-bold">‚úî</span>
          <p id="phone_number_error" class="text-red-400 text-xs mt-1 hidden">Phone number is required.</p>
        </div>

        <!-- Address -->
        <div class="relative">
          <label for="address" class="block font-medium mb-1 text-gray-200">Address</label>
          <input type="text" id="address" name="address" placeholder="e.g. City, Country" required
                 class="w-full px-4 py-2 rounded-xl bg-white/10 text-white border border-gray-500/30
                        focus:ring-2 focus:ring-purple-500 focus:outline-none"/>
          <span id="address_check" class="hidden absolute right-3 top-[46px] -translate-y-1/2 text-green-500 text-xl font-bold">‚úî</span>
          <p id="address_error" class="text-red-400 text-xs mt-1 hidden">Address is required.</p>
        </div>

        <!-- Last Seen (optional) -->
        <div class="relative md:col-span-2">
          <label for="last_seen" class="block font-medium mb-1 text-gray-200">Last Seen (optional)</label>
          <input type="text" id="last_seen" name="last_seen" placeholder="e.g. Street, City, DD-MM-YYYY"
                 class="w-full px-4 py-2 rounded-xl bg-white/10 text-white border border-gray-500/30
                        focus:ring-2 focus:ring-purple-500 focus:outline-none"/>
          <span id="last_seen_check" class="hidden absolute right-3 top-[46px] -translate-y-1/2 text-green-500 text-xl font-bold">‚úî</span>
        </div>
      </div>

      <!-- Divider before Registered By -->
      <div class="w-full border-t border-white/20 my-6"></div>

      <!-- Registered By Heading + Checkbox with Tooltip -->
      <div class="flex items-center justify-between gap-4 mb-6">
        <h3 class="text-lg font-bold text-gray-200 flex items-center gap-2">
          üë§ Registered By
        </h3>

        <!-- Checkbox + Info -->
        <label class="flex items-center gap-2 text-sm font-normal cursor-pointer relative">
          <input type="checkbox" id="same_as_guardian"
                 class="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500">
          <span class="text-gray-200">Same as Guardian</span>

          <!-- Info button -->
          <button type="button" id="info-btn" aria-label="Info about Same as Guardian"
                  class="ml-3 h-5 w-5 text-gray-400 hover:text-blue-400 focus:outline-none">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M13 16h-1v-4h-1m1-4h.01M12 2a10 10 0 100 20 10 10 0 000-20z"/>
            </svg>
          </button>
        </label>
      </div>

      <!-- Tooltip (same-as-guardian): hidden by default -->
      <div class="relative mb-6">
        <span id="info-tooltip"
              class="absolute left-0 -translate-y-2 w-64 sm:w-56 text-xs bg-gray-900 text-white rounded-lg py-2 px-3
                     opacity-0 pointer-events-none transform transition-all duration-300 ease-out animate-tooltip-pulse z-50">
          If selected, the Guardian's Name and Phone Number will be automatically filled and locked.
          <svg id="info-tooltip-arrow" class="absolute -top-1 left-1/2 -translate-x-1/2 w-3 h-3 text-gray-900" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M0 5 L5 10 L10 5 Z" fill="currentColor"/></svg>
        </span>
      </div>

      <!-- Registered By Fields -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="relative">
          <label for="registered_by_name" class="block font-medium mb-1 text-gray-200">Name</label>
          <input type="text" id="registered_by_name" name="registered_by_name" placeholder="Full Name" required
                 class="w-full px-4 py-2 rounded-xl bg-white/10 text-white border border-gray-500/30
                        focus:ring-2 focus:ring-purple-500 focus:outline-none"/>
          <span id="registered_by_name_check"
                class="hidden absolute right-3 top-[46px] -translate-y-1/2 text-green-500 text-xl font-bold">‚úî</span>
          <p id="registered_by_name_error" class="text-red-400 text-xs mt-1 hidden">Your name is required.</p>
        </div>

        <div class="relative">
          <label for="registered_by_phone" class="block font-medium mb-1 text-gray-200">Phone Number</label>
          <input type="text" id="registered_by_phone" name="registered_by_phone" placeholder="e.g., 9876543210" required
                 class="w-full px-4 py-2 rounded-xl bg-white/10 text-white border border-gray-500/30
                        focus:ring-2 focus:ring-purple-500 focus:outline-none"/>
          <span id="registered_by_phone_check"
                class="hidden absolute right-3 top-[46px] -translate-y-1/2 text-green-500 text-xl font-bold">‚úî</span>
          <p id="registered_by_phone_error" class="text-red-400 text-xs mt-1 hidden">Your phone number is required.</p>
        </div>

        <div class="relative">
          <label for="registered_by_relation" class="block font-medium mb-1 text-gray-200">Relation</label>
          <input type="text" id="registered_by_relation" name="registered_by_relation" placeholder="e.g. Parent, Sibling" required
                 class="w-full px-4 py-2 rounded-xl bg-white/10 text-white border border-gray-500/30
                        focus:ring-2 focus:ring-purple-500 focus:outline-none"/>
          <span id="registered_by_relation_check"
                class="hidden absolute right-3 top-[46px] -translate-y-1/2 text-green-500 text-xl font-bold">‚úî</span>
          <p id="registered_by_relation_error" class="text-red-400 text-xs mt-1 hidden">Relation is required.</p>
        </div>
      </div>

      <!-- Divider: Consent -->
      <div class="relative w-full flex justify-center my-8 sm:my-12">
        <div class="h-px w-3/4 sm:w-2/3 lg:w-1/2 bg-gradient-to-r from-transparent via-gray-400/40 to-transparent"></div>
        <span class="absolute -top-3 bg-blue-900 text-gray-200 text-xs sm:text-sm px-3 py-1 rounded-full shadow-md tracking-wide">
          Consent
        </span>
      </div>

      <!-- Agreement Block -->
      <div class="mt-4 flex items-center gap-2 relative">
        <input type="checkbox" id="agreement" name="agreement"
               class="mt-1 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
        <label for="agreement"
               class="text-[0.7rem] sm:text-xs leading-relaxed text-gray-200 flex-1 font-sans">
          I confirm that the information and photo provided are accurate and may be used for identification and registration purposes, in accordance with the
          <a href="{{ url_for('privacy_policy') }}" class="text-blue-400 hover:underline">Privacy Policy</a> and
          <a href="{{ url_for('terms') }}" class="text-blue-400 hover:underline">Terms of Service</a> of
          <span class="font-extrabold tracking-widest bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500
                       bg-clip-text text-transparent animate-gradient drop-shadow-md">
            PersonFinder.
          </span>
        </label>

        <button type="button" id="agreement_info_btn"
                class="ml-1 flex items-center justify-center h-5 w-5 text-gray-400 hover:text-blue-400 relative group" aria-label="Agreement info">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
            <path fill-rule="evenodd"
                  d="M18 10c0 4.418-3.582 8-8 8s-8-3.582-8-8 3.582-8
                     8-8 8 3.582 8 8zm-8-4a1 1 0 100 2 1 1 0
                     000-2zm-1 4a1 1 0 012 0v4a1 1 0 11-2
                     0v-4z" clip-rule="evenodd" />
          </svg>
        </button>
      </div>

      <!-- Toast & Tooltip Container -->
      <div class="relative">
        <div id="agreement_toast"
             class="fixed bottom-4 left-1/2 -translate-x-1/2 max-w-[90vw] w-auto px-4 py-3 text-sm
                    text-white bg-red-600 rounded shadow-md z-50 opacity-0 pointer-events-none
                    transition-all duration-300 ease-in-out translate-y-8 hidden" role="alert" aria-live="polite">
          <span>Please review and accept the terms before submitting the form.</span>
          <button id="toast_close_btn"
                  class="absolute top-1 right-2 text-white hover:text-gray-200 text-lg leading-none" aria-label="Close">
            √ó
          </button>
        </div>

        <div id="agreement_tooltip"
             class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-64 bg-gray-800 text-white text-xs p-2 rounded shadow-lg
                    opacity-0 pointer-events-none transition-opacity duration-200 z-50 text-center hidden">
          Please review and accept the terms before submitting the form.
        </div>
      </div>

      <!-- Google reCAPTCHA v3 -->
      <input type="hidden" id="g-recaptcha-response" name="g-recaptcha-response">

      <!-- Submit Button -->
      <div class="flex justify-center mt-8">
        <button type="button" id="register_btn"
                class="px-14 py-3 rounded-xl text-white font-semibold text-lg shadow-lg
                       transform transition hover:scale-105 bg-gradient-to-r from-green-500 to-blue-500
                       relative overflow-hidden flex items-center justify-center gap-2
                       w-auto min-w-[220px] max-w-[420px]">
          <svg id="register_spinner"
               class="hidden w-5 h-5 animate-spin spinner-pulse text-white mr-2"
               xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
            <circle class="opacity-25" cx="12" cy="12" r="10"
                    stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor"
                  d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
          <span id="register_text">Register</span>
          <span class="absolute inset-0 rounded-xl shimmer pointer-events-none"></span>
        </button>
      </div>

      {% if errors.get("recaptcha") %}
        <p class="text-red-500 text-xs mt-2 text-center">
          {{ errors["recaptcha"] }}
        </p>
      {% endif %}

      <p id="review_note"
         class="text-xs flex items-center justify-center gap-2 mt-4 opacity-0 transform translate-y-6 transition-all duration-500">
        <svg xmlns="http://www.w3.org/2000/svg"
             class="h-4 w-4 text-yellow-500"
             fill="none" viewBox="0 0 24 24"
             stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M13 16h-1v-4h-1m1-4h.01M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9
                   4.03-9 9-9 9 4.03 9 9z" />
        </svg>
        Please review details before submitting.
      </p>

      <!-- Load reCAPTCHA v3 (only once, with render param) -->
      <script src="https://www.google.com/recaptcha/api.js?render={{ RECAPTCHA_SITE_KEY }}" async defer></script>

    </div> <!-- End card -->

  </form> <!-- End form -->

</div>

<!-- Note Divider -->
<div class="relative w-full flex justify-center my-16 sm:my-20">
  <div class="h-px w-3/4 sm:w-2/3 lg:w-1/2 bg-gradient-to-r from-transparent via-gray-400/40 to-transparent"></div>
  <span class="absolute -top-3 bg-blue-900 text-gray-200 text-xs sm:text-sm px-3 py-1 rounded-full shadow-md tracking-wide">
    Note
  </span>
</div>

<div class="info-box bg-indigo-900/40 border border-indigo-500/30 rounded-xl p-6 shadow-lg
            max-w-2xl mx-auto text-center mb-20 animate-slide-in animate-pulse-slow">
  <p class="text-xs sm:text-sm leading-relaxed text-gray-200">
    ‚ö†Ô∏è All information provided will only be used for search and identification purposes within
    <span class="font-semibold gradient-text">PersonFinder</span>.
    Your data is stored securely and not shared with third parties.
    Providing accurate details helps us <span class="text-green-300 font-semibold">reunite families faster</span>.
  </p>
</div>

<!-- ================= FULL JS (organized; prevents 413; agreement guard) ================= -->
<script>
/* ===== Perf helpers ===== */
const runIdle = (fn) => ('requestIdleCallback' in window) ? requestIdleCallback(fn, { timeout: 800 }) : setTimeout(fn, 0);

/* ===== Toast ===== */
function showServerToast(message, type = "success", opts = {}) {
  let root = document.getElementById("server_toast_root");
  if (!root) {
    root = document.createElement("div");
    root.id = "server_toast_root";
    root.setAttribute("aria-hidden", "true");
    document.body.appendChild(root);
  }
  const toast = document.createElement("div");
  toast.className = "server-toast " + (type === "success" ? "success" : "error");
  toast.setAttribute("role", "status");
  toast.innerHTML = `<div class="msg">${String(message)}</div><button class="close-btn" title="Close" aria-label="Close">‚úï</button>`;
  root.appendChild(toast);
  requestAnimationFrame(() => toast.classList.add("show"));
  const close = () => { toast.classList.remove("show"); setTimeout(() => { try { toast.remove(); } catch (_) {} }, 320); };
  toast.querySelector(".close-btn").addEventListener("click", close, { passive: true });
  const timeout = (opts && typeof opts.timeout === "number") ? opts.timeout : 4000;
  if (timeout > 0) setTimeout(close, timeout);
}

/* ===== Image Compression (keep dimensions) ===== */
const IMG_TARGET_MAX_BYTES = 400 * 1024; // ~400KB
const IMG_MIN_QUALITY     = 0.5;
const IMG_START_QUALITY   = 0.9;

function isHeicLike(type, name='') {
  const t = (type||'').toLowerCase();
  const n = (name||'').toLowerCase();
  return t.includes('heic') || t.includes('heif') || n.endsWith('.heic') || n.endsWith('.heif');
}
function blobToDataURL(blob) {
  return new Promise((res, rej) => {
    const fr = new FileReader();
    fr.onload = () => res(fr.result);
    fr.onerror = rej;
    fr.readAsDataURL(blob);
  });
}
function fileToDataURL(file) {
  return new Promise((resolve, reject) => {
    const fr = new FileReader();
    fr.onload = () => resolve(fr.result);
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}
async function fileToOptimizedDataURL(file) {
  if (!file) return null;
  // Pass-through if already small enough
  if (file.size <= IMG_TARGET_MAX_BYTES) return await fileToDataURL(file);

  if (isHeicLike(file.type, file.name)) {
    showServerToast("HEIC/HEIF isn‚Äôt supported in browser. Please upload JPG/PNG/WebP.", "error");
    throw new Error("heic-not-supported");
  }

  const bitmap = await createImageBitmap(file).catch(async () => {
    const dataUrl = await fileToDataURL(file);
    const img = await new Promise((resolve, reject) => {
      const i = new Image();
      i.onload = () => resolve(i);
      i.onerror = reject;
      i.decoding = 'async';
      i.src = dataUrl;
    });
    return { _fallbackImage: img, width: img.naturalWidth || img.width, height: img.naturalHeight || img.height };
  });

  const drawSource = bitmap.close ? bitmap : bitmap._fallbackImage;
  const w = bitmap.width, h = bitmap.height;
  const canvas = document.createElement('canvas');
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d', { alpha: false });
  ctx.imageSmoothingEnabled = true;
  ctx.imageSmoothingQuality = 'high';
  ctx.drawImage(drawSource, 0, 0, w, h);
  if (bitmap.close) { try { bitmap.close(); } catch(_){} }

  const toBlobQ = (q) => new Promise(res => canvas.toBlob(b => res(b), 'image/jpeg', q));
  let q = IMG_START_QUALITY;
  let blob = await toBlobQ(q);
  while (blob && blob.size > IMG_TARGET_MAX_BYTES && q > IMG_MIN_QUALITY) {
    q = Math.max(IMG_MIN_QUALITY, q - 0.1);
    blob = await toBlobQ(q);
  }
  return await blobToDataURL(blob);
}
async function canvasToTargetJpegNoResize(sourceCanvas, targetBytes) {
  const canvas = document.createElement('canvas');
  canvas.width = sourceCanvas.width;
  canvas.height = sourceCanvas.height;
  const ctx = canvas.getContext('2d', { alpha: false });
  ctx.imageSmoothingEnabled = true;
  ctx.imageSmoothingQuality = 'high';
  ctx.drawImage(sourceCanvas, 0, 0);
  const toBlobQ = (q) => new Promise(res => canvas.toBlob(b => res(b), 'image/jpeg', q));
  let q = IMG_START_QUALITY;
  let blob = await toBlobQ(q);
  while (blob && blob.size > targetBytes && q > IMG_MIN_QUALITY) {
    q = Math.max(IMG_MIN_QUALITY, q - 0.1);
    blob = await toBlobQ(q);
  }
  return await blobToDataURL(blob);
}

/* ===== Elements ===== */
let webcamStream = null;
const useWebcamBtn = document.getElementById("use_webcam_btn"),
      webcamContainer = document.getElementById("webcam_container"),
      webcamVideo = document.getElementById("webcam"),
      captureBtn = document.getElementById("capture_btn"),
      closeWebcamBtn = document.getElementById("close_webcam_btn"),
      photoFileInput = document.getElementById("photo"),
      photoHiddenInput = document.getElementById("photo_input"),
      photoPreviewContainer = document.getElementById("photo_preview_container"),
      photoPreviewImg = document.getElementById("photo_preview"),
      photoError = document.getElementById("photo_error"),
      photoCheck = document.getElementById("photo_check"),
      uploadLabel = document.getElementById("upload_label");

/* ===== File field suppress/restore helpers (to avoid 413) ===== */
const originalFileNameAttr = photoFileInput ? (photoFileInput.getAttribute('name') || 'photo') : 'photo';
function suppressFileField() {
  if (!photoFileInput) return;
  // strip name and value so the big file isn‚Äôt posted
  photoFileInput.value = "";
  photoFileInput.setAttribute('data-suppressed', '1');
  photoFileInput.removeAttribute('name');
}
function restoreFileField() {
  if (!photoFileInput) return;
  if (photoFileInput.getAttribute('data-suppressed') === '1') {
    photoFileInput.setAttribute('name', originalFileNameAttr);
    photoFileInput.removeAttribute('data-suppressed');
  }
}

/* ===== Webcam handling ===== */
function toggleWebcam(){ (webcamContainer && webcamContainer.classList.contains("hidden")) ? openWebcam() : closeWebcam(); }
function openWebcam(){
  if (!navigator.mediaDevices || !webcamVideo || !webcamContainer) { showServerToast("Webcam not available.","error"); return; }
  navigator.mediaDevices.getUserMedia({ video: { width:{max:1920}, height:{max:1080} } })
    .then(stream => { webcamStream = stream; webcamVideo.srcObject = stream; webcamContainer.classList.remove("hidden"); webcamVideo.play().catch(()=>{}); })
    .catch(()=> showServerToast("Webcam access denied.","error"));
}
function closeWebcam(){
  if (webcamStream) { try { webcamStream.getTracks().forEach(t=>t.stop()); } catch(_){} }
  webcamStream = null;
  webcamContainer && webcamContainer.classList.add("hidden");
}
async function capturePhoto(){
  if (!webcamVideo) return;
  const tmp = document.createElement("canvas");
  tmp.width = webcamVideo.videoWidth || 640;
  tmp.height = webcamVideo.videoHeight || 480;
  tmp.getContext("2d").drawImage(webcamVideo, 0, 0, tmp.width, tmp.height);
  try {
    const dataUrl = await canvasToTargetJpegNoResize(tmp, IMG_TARGET_MAX_BYTES);
    setOptimizedPreview(dataUrl);
    suppressFileField(); // ensure we only send base64
  } catch { showServerToast("Failed to process webcam photo.","error"); }
  closeWebcam();
}
if (useWebcamBtn) useWebcamBtn.addEventListener("click", toggleWebcam, { passive:true });
if (captureBtn) captureBtn.addEventListener("click", capturePhoto);
if (closeWebcamBtn) closeWebcamBtn.addEventListener("click", closeWebcam, { passive:true });

/* ===== Preview & clear ===== */
function setOptimizedPreview(dataUrl){
  if (!dataUrl) return;
  if (photoHiddenInput) photoHiddenInput.value = dataUrl;
  if (photoPreviewImg && photoPreviewContainer) {
    photoPreviewImg.src = dataUrl;
    photoPreviewContainer.classList.remove("hidden");
    photoCheck && photoCheck.classList.remove("hidden");
    photoError && photoError.classList.add("hidden");
  }
  updatePhotoValidity(); updateRegisterButtonState();
}
function clearPhoto(){
  if (photoPreviewContainer) photoPreviewContainer.classList.add("hidden");
  if (photoPreviewImg) photoPreviewImg.src = "";
  if (photoHiddenInput) photoHiddenInput.value = "";
  if (photoFileInput) photoFileInput.value = "";
  restoreFileField(); // allow file upload again
  photoCheck && photoCheck.classList.add("hidden");
  updatePhotoValidity(); updateRegisterButtonState();
}
window.clearPhoto = clearPhoto;

/* ===== File input ‚Üí compress to base64 & suppress file field ===== */
if (photoFileInput) {
  photoFileInput.addEventListener("change", async (e) => {
    const f = e.target.files && e.target.files[0];
    if (!f) { clearPhoto(); return; }
    try {
      const dataUrl = await fileToOptimizedDataURL(f); // keeps pixels, reduces bytes
      setOptimizedPreview(dataUrl);
      suppressFileField(); // CRITICAL: don‚Äôt post the raw file alongside base64
    } catch (err) {
      if (String(err && err.message).includes('heic')) return; // already shown toast
      showServerToast("Could not process the selected image.","error");
    }
  });
}

/* ===== Validation ===== */
let showErrors = false;
const fields = [
  { id: "full_name", errorId: "full_name_error", checkId: "full_name_check" },
  { id: "age", errorId: "age_error", checkId: "age_check" },
  { id: "gender", errorId: "gender_error", checkId: "gender_check" },
  { id: "guardian_name", errorId: "guardian_name_error", checkId: "guardian_name_check" },
  { id: "phone_number", errorId: "phone_number_error", checkId: "phone_number_check" },
  { id: "address", errorId: "address_error", checkId: "address_check" },
  { id: "last_seen", errorId: null, checkId: "last_seen_check" },
  { id: "registered_by_name", errorId: "registered_by_name_error", checkId: "registered_by_name_check" },
  { id: "registered_by_phone", errorId: "registered_by_phone_error", checkId: "registered_by_phone_check" },
  { id: "registered_by_relation", errorId: "registered_by_relation_error", checkId: "registered_by_relation_check" }
];
function showCheckById(id){ const el=document.getElementById(id); if (el){ el.classList.remove("hidden"); el.classList.add("text-green-500"); } }
function hideCheckById(id){ const el=document.getElementById(id); if (el){ el.classList.add("hidden"); el.classList.remove("text-green-500"); } }
function validateField(fieldId, errorId, checkId){
  const input=document.getElementById(fieldId); if (!input) return true;
  let valid=true; const err=errorId && document.getElementById(errorId);
  valid = !!(input.value?.toString().trim() !== "" && !(input.tagName === "SELECT" && input.value === ""));
  if (errorId){
    if (valid){ err && err.classList.add("hidden"); showCheckById(checkId); }
    else { if (showErrors && err) err.classList.remove("hidden"); hideCheckById(checkId); }
  } else { input.value?.toString().trim() !== "" ? showCheckById(checkId) : hideCheckById(checkId); }
  return valid;
}
function updatePhotoValidity(){
  const ok = !!((photoHiddenInput && photoHiddenInput.value.trim() !== "") || (photoFileInput && photoFileInput.files.length > 0));
  if (photoError) photoError.classList.toggle("hidden", ok || !showErrors);
  if (photoCheck) photoCheck.classList.toggle("hidden", !ok);
  return ok;
}
window.updatePhotoValidity = updatePhotoValidity;
fields.forEach(f => {
  const el=document.getElementById(f.id);
  if (!el) return;
  const h=()=>{ validateField(f.id, f.errorId, f.checkId); updateRegisterButtonState(); };
  (el.tagName === "SELECT" ? el.addEventListener("change", h) : el.addEventListener("input", h));
  setTimeout(()=>validateField(f.id, f.errorId, f.checkId), 40);
});

/* ===== Registered By sync ===== */
const sameAsGuardianCheckbox = document.getElementById("same_as_guardian"),
      guardianNameInput = document.getElementById("guardian_name"),
      guardianPhoneInput = document.getElementById("phone_number"),
      regNameInput = document.getElementById("registered_by_name"),
      regPhoneInput = document.getElementById("registered_by_phone"),
      regRelationInput = document.getElementById("registered_by_relation");
function setRegisteredByReadonly(disable){
  [regNameInput, regPhoneInput, regRelationInput].forEach(f => { if (!f) return; f.readOnly = !!disable; if (disable) f.classList.add("bg-gray-100","text-gray-700"); else f.classList.remove("bg-gray-100","text-gray-700"); });
}
function syncGuardianToRegistered(){
  if (regNameInput && guardianNameInput) regNameInput.value = guardianNameInput.value || "";
  if (regPhoneInput && guardianPhoneInput) regPhoneInput.value = guardianPhoneInput.value || "";
  if (regRelationInput) regRelationInput.value = "Guardian";
  ["registered_by_name","registered_by_phone","registered_by_relation"].forEach(id => { const f=fields.find(x=>x.id===id); validateField(f.id, f.errorId, f.checkId); });
  updateRegisterButtonState();
}
if (sameAsGuardianCheckbox) sameAsGuardianCheckbox.addEventListener("change", () => {
  if (sameAsGuardianCheckbox.checked){
    syncGuardianToRegistered(); setRegisteredByReadonly(true);
    guardianNameInput?.addEventListener("input", syncGuardianToRegistered);
    guardianPhoneInput?.addEventListener("input", syncGuardianToRegistered);
  } else {
    guardianNameInput?.removeEventListener("input", syncGuardianToRegistered);
    guardianPhoneInput?.removeEventListener("input", syncGuardianToRegistered);
    if (regNameInput) regNameInput.value = "";
    if (regPhoneInput) regPhoneInput.value = "";
    if (regRelationInput) regRelationInput.value = "";
    setRegisteredByReadonly(false);
    ["registered_by_name","registered_by_phone","registered_by_relation"].forEach(id => { const f=fields.find(x=>x.id===id); validateField(f.id, f.errorId, f.checkId); hideCheckById(id+"_check"); });
    updateRegisterButtonState();
  }
}, { passive:true });

/* ===== Same-as-guardian tooltip ===== */
const infoBtnEl = document.getElementById("info-btn"),
      infoTooltip = document.getElementById("info-tooltip");
let infoTooltipTimer=null;
function showInfoTooltip(){ if (!infoTooltip) return; clearTimeout(infoTooltipTimer); infoTooltip.classList.remove("opacity-0","pointer-events-none"); infoTooltip.classList.add("opacity-100","pointer-events-auto"); infoTooltip.style.visibility="visible"; infoTooltipTimer=setTimeout(hideInfoTooltip,4000); }
function hideInfoTooltip(){ if (!infoTooltip) return; infoTooltip.classList.add("opacity-0","pointer-events-none"); infoTooltip.classList.remove("opacity-100","pointer-events-auto"); infoTooltip.style.visibility="hidden"; clearTimeout(infoTooltipTimer); }
if (infoBtnEl && infoTooltip){
  infoTooltip.style.visibility="hidden";
  infoBtnEl.addEventListener("mouseenter", showInfoTooltip, { passive:true });
  infoBtnEl.addEventListener("mouseleave", hideInfoTooltip, { passive:true });
  infoBtnEl.addEventListener("click", (e)=>{ e.stopPropagation(); (infoTooltip.style.visibility==="visible")?hideInfoTooltip():showInfoTooltip(); });
  document.addEventListener("click", (e)=>{ if (!infoBtnEl.contains(e.target) && infoTooltip.style.visibility==="visible") hideInfoTooltip(); }, { passive:true });
}

/* ===== Agreement helpers ===== */
function showAgreementTooltipIfAvailable(){
  const t=document.getElementById("agreement_tooltip"); if (!t) return;
  t._tipTimer && clearTimeout(t._tipTimer);
  t.classList.remove("hidden","opacity-0","pointer-events-none");
  t.classList.add("opacity-100","pointer-events-auto","animate-subtle-bounce");
  t.style.visibility="visible";
  t._tipTimer=setTimeout(()=>{ t.classList.add("opacity-0","pointer-events-none"); t.classList.remove("opacity-100","pointer-events-auto","animate-subtle-bounce"); t.style.visibility="hidden"; t._tipTimer=null; }, 3500);
}
function showAgreementWarningToast(timeout=3500){
  const t=document.getElementById("agreement_toast");
  if (!t){ showServerToast("Please accept the agreement before registering.","error",{timeout}); return; }
  t._agTimer && clearTimeout(t._agTimer);
  t.classList.remove("opacity-0","pointer-events-none","hidden");
  t.classList.add("opacity-100"); t.style.visibility="visible";
  t._agTimer=setTimeout(()=>{ t.classList.add("opacity-0","pointer-events-none"); t.classList.remove("opacity-100"); setTimeout(()=>{ t.classList.add("hidden"); },320); t._agTimer=null; }, timeout);
}

/* ===== Submit control ===== */
const registerForm = document.getElementById("register_form"),
      registerBtn = document.getElementById("register_btn"),
      registerSpinner = document.getElementById("register_spinner"),
      registerText = document.getElementById("register_text");

function allFieldsValid(){ return fields.every(f => validateField(f.id, f.errorId, f.checkId)); }
function updateRegisterButtonState(){
  if (!registerBtn) return;
  const agreement = document.getElementById("agreement");
  const ok = allFieldsValid() && updatePhotoValidity() && !!(agreement && agreement.checked);
  if (ok){ registerBtn.classList.remove("opacity-60","cursor-not-allowed"); registerBtn.setAttribute("aria-disabled","false"); }
  else  { registerBtn.classList.add("opacity-60","cursor-not-allowed"); registerBtn.setAttribute("aria-disabled","true"); }
}
window.updateRegisterButtonState = updateRegisterButtonState;

function doSubmitWithRecaptcha(){
  if (typeof grecaptcha === "undefined"){ showServerToast("Security check failed. Please try again.","error"); return; }

  // FINAL GUARD: if we have base64, guarantee the file field is not posted
  if (photoHiddenInput && photoHiddenInput.value.trim() !== "") suppressFileField();

  registerSpinner && registerSpinner.classList.remove("hidden");
  registerText && (registerText.textContent = "Checking...");
  grecaptcha.ready(function(){
    grecaptcha.execute('{{ RECAPTCHA_SITE_KEY }}', {action:'register'}).then(function(token){
      const recaptchaInput = document.getElementById("g-recaptcha-response");
      if (recaptchaInput) recaptchaInput.value = token || "";
      // Real submit
      const realSubmit = document.createElement('button');
      realSubmit.type = 'submit'; realSubmit.style.display = 'none';
      registerForm.appendChild(realSubmit); realSubmit.click(); realSubmit.remove();
    }).catch(()=>{ showServerToast("reCAPTCHA failed. Try again.","error"); registerSpinner && registerSpinner.classList.add("hidden"); registerText && (registerText.textContent = "Register"); });
  });
}

if (registerBtn){
  registerBtn.addEventListener("click", (ev)=>{
    ev.preventDefault();
    let invalid=false;

    if (!updatePhotoValidity()){
      invalid=true;
      if (photoError) photoError.classList.remove("hidden");
      uploadLabel && uploadLabel.scrollIntoView({ behavior:"smooth", block:"center" });
      uploadLabel && uploadLabel.classList.add("shake");
      setTimeout(()=> uploadLabel && uploadLabel.classList.remove("shake"), 600);
    }

    if (!invalid){
      for (const f of fields){
        const el=document.getElementById(f.id);
        if (el && f.errorId && (!el.value || el.value.trim()==="" || (el.tagName==="SELECT" && el.value===""))){
          invalid=true; el.scrollIntoView({ behavior:"smooth", block:"center" }); el.focus({ preventScroll:true }); break;
        }
      }
    }

    const agreementEl=document.getElementById("agreement");
    if (!invalid && agreementEl && !agreementEl.checked){
      invalid=true;
      agreementEl.scrollIntoView({ behavior:"smooth", block:"center" });
      agreementEl.focus({ preventScroll:true });
      showAgreementTooltipIfAvailable();
      showAgreementWarningToast(3500);
      agreementEl.classList.add("border-red-500","ring-red-300","ring-1");
      const clearWarning=()=>{ agreementEl.classList.remove("border-red-500","ring-red-300","ring-1"); agreementEl.removeEventListener("change", clearWarning); };
      agreementEl.addEventListener("change", clearWarning, { passive:true });
    }

    if (invalid){ registerSpinner && registerSpinner.classList.add("hidden"); registerText && (registerText.textContent="Register"); return; }
    doSubmitWithRecaptcha();
  });
}

runIdle(updateRegisterButtonState);
</script>

<!-- ===== CSS ===== -->
<style>
@keyframes pageFadeSlide {0%{opacity:0;transform:translateY(14px) scale(0.98);filter:blur(2px);}100%{opacity:1;transform:translateY(0) scale(1);filter:blur(0);}}
.animate-page-enter{animation:pageFadeSlide .7s cubic-bezier(.22,.61,.36,1) both;}

@keyframes cardRise{0%{opacity:0;transform:translateY(10px);}100%{opacity:1;transform:translateY(0);}}
.animate-card{animation:cardRise .55s cubic-bezier(.22,.61,.36,1) both;}

@keyframes shimmer{0%{transform:translateX(-100%);}100%{transform:translateX(100%);}}
.shimmer{background:linear-gradient(120deg,rgba(255,255,255,0.30) 0%,rgba(255,255,255,0.12) 40%,transparent 100%);animation:shimmer 2.5s infinite linear;}

@keyframes subtle-bounce{0%,100%{transform:translateY(0);}50%{transform:translateY(-3px);}}
.animate-subtle-bounce{animation:subtle-bounce 1s infinite ease-in-out;}

/* Upload label shake on error */
@keyframes shake { 
  0% { transform: translateX(0);} 
  25% { transform: translateX(-6px);} 
  50% { transform: translateX(6px);} 
  75% { transform: translateX(-6px);} 
  100% { transform: translateX(0);} 
}
.shake { animation: shake 0.42s ease; }

.server-toast{position:fixed;right:1rem;bottom:1rem;max-width:min(92vw,420px);padding:0.6rem 0.9rem;border-radius:0.6rem;box-shadow:0 8px 20px rgba(0,0,0,0.35);display:flex;gap:0.75rem;align-items:center;z-index:9999;transform:translateY(12px);opacity:0;transition:all 320ms ease;}
.server-toast.show{transform:translateY(0);opacity:1;}
.server-toast .msg{flex:1;font-size:0.92rem;color:#fff;}
.server-toast.success{background:#16a34a;}
.server-toast.error{background:#dc2626;}
.server-toast .close-btn{cursor:pointer;background:rgba(255,255,255,0.12);padding:0.2rem 0.45rem;border-radius:6px;color:#fff;font-weight:700;}

@keyframes slideInUp { 0% { opacity: 0; transform: translateY(18px) scale(.994); filter: blur(2px); }
  60% { opacity: 1; transform: translateY(-6px) scale(1.002); filter: none; }
  100% { opacity: 1; transform: translateY(0) scale(1); filter: none; } }
@keyframes pulseInOut { 0% { transform: scale(0.985); opacity: 0.88; }
  50% { transform: scale(1.02);  opacity: 1; }
  100% { transform: scale(0.985); opacity: 0.88; } }
.animate-slide-in { animation: slideInUp 700ms cubic-bezier(.22,.61,.36,1) both; will-change: transform, opacity; }
.animate-pulse-slow {
  animation: slideInUp 700ms cubic-bezier(.22,.61,.36,1) both, pulseInOut 2800ms ease-in-out 700ms infinite;
  transform-origin: center; will-change: transform, opacity; backface-visibility: hidden; -webkit-font-smoothing: antialiased;
}
.info-box.animate-slide-in.animate-pulse-slow { opacity: 1 !important; }

@media (prefers-reduced-motion: reduce) {
  .animate-slide-in, .animate-pulse-slow { animation: none !important; transition: none !important; }
}
</style>

<!-- reCAPTCHA loader (kept once) -->
<script src="https://www.google.com/recaptcha/api.js" async defer></script>
{% endblock %}
