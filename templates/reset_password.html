{% extends "base.html" %}
{% block title %}Reset Password - PersonFinder{% endblock %}

{% block content %}
<div class="flex min-h-screen justify-center items-center px-4 sm:px-6 lg:px-8">
  <div class="bg-white/10 backdrop-blur-md shadow-xl rounded-2xl p-8 w-full max-w-md border border-gray-700 
              transition-transform duration-300 transform hover:scale-105 animate-slideFadeIn md:max-w-lg">

    <h2 class="text-3xl sm:text-4xl font-extrabold text-white mb-4 text-center">Set New Admin Password</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="space-y-2 mb-4">
          {% for category, message in messages %}
            <div class="text-sm px-3 py-2 rounded-lg
                        {% if category == 'error' %} bg-red-500/20 text-red-300 border border-red-500/40
                        {% elif category == 'success' %} bg-green-500/20 text-green-300 border border-green-500/40
                        {% else %} bg-gray-500/20 text-gray-200 border border-gray-500/40 {% endif %}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <form method="POST" action="{{ url_for('reset_password', token=token) }}" class="space-y-5">

      <!-- Password input -->
      <div>
        <label class="block text-sm font-medium text-gray-200">New Password</label>

        <div class="relative mt-1">
          <input id="password" name="password" type="password" required
                 class="block w-full px-4 py-2 pr-12 rounded-xl bg-gray-800/60 border border-gray-600 text-gray-100 focus:ring-2 focus:ring-blue-500"
                 placeholder="Enter new password" autocomplete="new-password" spellcheck="false" autocapitalize="none" autocorrect="off">

          <!-- Eye toggle button -->
          <button type="button" id="togglePassword"
                  class="absolute right-2 top-1/2 -translate-y-1/2 inline-flex h-8 w-8 items-center justify-center rounded-full text-gray-400 hover:text-gray-200 hover:bg-white/10 transition"
                  aria-label="Show password" aria-pressed="false">
            <!-- Eye open -->
            <svg id="eyeOpen" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                 stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
            </svg>
            <!-- Eye closed -->
            <svg id="eyeClosed" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24"
                 stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7a9.956 9.956 0 012.042-3.36m3.56-2.318A9.958 9.958 0 0112 5c4.477 0 8.268 2.943 9.542 7a9.955 9.955 0 01-4.155 5.362M3 3l18 18"/>
            </svg>
          </button>
        </div>

        <!-- Caps Lock hint -->
        <div class="min-h-[1.25rem] mt-2">
          <div id="capsHint"
               class="flex items-center gap-1 text-yellow-300 text-xs font-semibold invisible transition-opacity duration-150">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 3l9 9h-6v6H9v-6H3l9-9z"/>
            </svg>
            <span>Caps Lock is ON</span>
          </div>
        </div>
      </div>

      <!-- Submit -->
      <div>
        <button type="submit" class="login-gradient-btn w-full py-2 px-4 rounded-xl bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 text-white font-semibold shadow-lg hover:opacity-90 transition relative overflow-hidden">
          Reset Password
        </button>
      </div>
    </form>

    <p class="mt-6 text-center text-gray-400 text-sm">
      Remembered your password? 
      <a href="{{ url_for('login') }}" class="text-blue-400 hover:text-blue-300 font-semibold">Login</a>
    </p>
  </div>
</div>

<!-- Styles -->
<style>
.login-gradient-btn::after {
  content: "";
  position: absolute;
  left: -60%;
  top: 0;
  width: 60%;
  height: 100%;
  background: linear-gradient(120deg, rgba(255,255,255,0.2), rgba(255,255,255,0.05), rgba(255,255,255,0.2));
  transform: skewX(-20deg);
  transition: left 0.9s ease;
}
.login-gradient-btn:hover::after { left: 150%; }

@keyframes slideFadeIn {
  0% { opacity: 0; transform: translateY(30px); }
  100% { opacity: 1; transform: translateY(0); }
}
.animate-slideFadeIn { animation: slideFadeIn 0.8s ease-out forwards; }
</style>

<!-- JS: Eye toggle + CapsLock -->
<script>
  (function(){
    const pass = document.getElementById('password');
    const capsHint = document.getElementById('capsHint');
    const toggle = document.getElementById('togglePassword');
    const eyeOpen = document.getElementById('eyeOpen');
    const eyeClosed = document.getElementById('eyeClosed');

    // Eye toggle
    if (toggle) {
      toggle.addEventListener('click', () => {
        const hidden = pass.type === 'password';
        pass.type = hidden ? 'text' : 'password';
        toggle.setAttribute('aria-pressed', String(hidden));
        toggle.setAttribute('aria-label', hidden ? 'Hide password' : 'Show password');
        eyeOpen.classList.toggle('hidden', !hidden);
        eyeClosed.classList.toggle('hidden', hidden);
      });
    }

    // Caps Lock detection
    function updateCaps(e){
      if (e.getModifierState && e.getModifierState('CapsLock')) {
        capsHint.classList.remove('invisible');
      } else {
        capsHint.classList.add('invisible');
      }
    }
    if (pass && capsHint) {
      pass.addEventListener('keydown', updateCaps);
      pass.addEventListener('keyup', updateCaps);
      pass.addEventListener('blur', () => capsHint.classList.add('invisible'));
    }
  })();
</script>{% extends "base.html" %}
{% block title %}Reset Password - PersonFinder{% endblock %}

{% block content %}
<div class="flex min-h-screen justify-center items-center px-4 sm:px-6 lg:px-8">
  <div class="bg-white/10 backdrop-blur-md shadow-xl rounded-2xl p-8 w-full max-w-md border border-gray-700 
              transition-transform duration-300 transform hover:scale-105 animate-slideFadeIn md:max-w-lg">

    <h2 class="text-3xl sm:text-4xl font-extrabold text-white mb-4 text-center">Set New Admin Password</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="space-y-2 mb-4">
          {% for category, message in messages %}
            <div class="text-sm px-3 py-2 rounded-lg
                        {% if category == 'error' %} bg-red-500/20 text-red-300 border border-red-500/40
                        {% elif category == 'success' %} bg-green-500/20 text-green-300 border border-green-500/40
                        {% else %} bg-gray-500/20 text-gray-200 border border-gray-500/40 {% endif %}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <form method="POST" action="{{ url_for('reset_password', token=token) }}" class="space-y-5">

      <!-- New password -->
      <div>
        <label class="block text-sm font-medium text-gray-200">New Password</label>

        <!-- wrapper is relative so the eye can be perfectly centered -->
        <div class="relative mt-1">
          <input id="password" name="password" type="password" required
                 class="block w-full px-4 py-2 pr-12 rounded-xl bg-gray-800/60 border border-gray-600 text-gray-100 focus:ring-2 focus:ring-blue-500"
                 placeholder="Enter new password" autocomplete="new-password" spellcheck="false" autocapitalize="none" autocorrect="off">

          <!-- Eye toggle (centered vertically) -->
          <button type="button" id="togglePassword"
                  class="absolute right-2 top-1/2 -translate-y-1/2 inline-flex h-8 w-8 items-center justify-center rounded-full text-gray-400 hover:text-gray-200 hover:bg-white/10 transition"
                  aria-label="Show password" aria-pressed="false">
            <!-- Eye open -->
            <svg id="eyeOpen" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                 stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
            </svg>
            <!-- Eye closed -->
            <svg id="eyeClosed" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24"
                 stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7a9.956 9.956 0 012.042-3.36m3.56-2.318A9.958 9.958 0 0112 5c4.477 0 8.268 2.943 9.542 7a9.955 9.955 0 01-4.155 5.362M3 3l18 18"/>
            </svg>
          </button>
        </div>

        <!-- Caps Lock hint: reserved space so no overlap -->
        <div class="min-h-[1.25rem] mt-2">
          <div id="capsHint"
               class="flex items-center gap-1 text-yellow-300 text-xs font-semibold invisible transition-opacity duration-150">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 3l9 9h-6v6H9v-6H3l9-9z"/>
            </svg>
            <span>Caps Lock is ON</span>
          </div>
        </div>
      </div>

      <!-- Submit -->
      <div>
        <button type="submit" class="login-gradient-btn w-full py-2 px-4 rounded-xl bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 text-white font-semibold shadow-lg hover:opacity-90 transition relative overflow-hidden">
          Reset Password
        </button>
      </div>
    </form>

    <p class="mt-6 text-center text-gray-400 text-sm">
      Remembered your password? 
      <a href="{{ url_for('login') }}" class="text-blue-400 hover:text-blue-300 font-semibold">Login</a>
    </p>
  </div>
</div>

<!-- Styles -->
<style>
.login-gradient-btn::after {
  content: "";
  position: absolute;
  left: -60%;
  top: 0;
  width: 60%;
  height: 100%;
  background: linear-gradient(120deg, rgba(255,255,255,0.2), rgba(255,255,255,0.05), rgba(255,255,255,0.2));
  transform: skewX(-20deg);
  transition: left 0.9s ease;
}
.login-gradient-btn:hover::after { left: 150%; }

@keyframes slideFadeIn { 0% { opacity: 0; transform: translateY(30px); } 100% { opacity: 1; transform: translateY(0); } }
.animate-slideFadeIn { animation: slideFadeIn 0.8s ease-out forwards; }
</style>
{% endblock %}

{# Put JS in the scripts block so it actually runs under typical base.html setups. #}
{% block scripts %}
<script {% if csp_nonce is defined %}nonce="{{ csp_nonce() }}"{% endif %}>
  // console.log('reset.js loaded'); // uncomment to verify it runs
  (function(){
    const pass = document.getElementById('password');
    const capsHint = document.getElementById('capsHint');
    const toggle = document.getElementById('togglePassword');
    const eyeOpen = document.getElementById('eyeOpen');
    const eyeClosed = document.getElementById('eyeClosed');

    // Eye toggle
    if (toggle && pass && eyeOpen && eyeClosed) {
      toggle.addEventListener('click', () => {
        const hidden = pass.type === 'password';
        pass.type = hidden ? 'text' : 'password';
        toggle.setAttribute('aria-pressed', String(hidden));
        toggle.setAttribute('aria-label', hidden ? 'Hide password' : 'Show password');
        eyeOpen.classList.toggle('hidden', !hidden);
        eyeClosed.classList.toggle('hidden', hidden);
      });
    }

    // Caps Lock detection
    function updateCaps(e){
      if (e.getModifierState && e.getModifierState('CapsLock')) {
        capsHint.classList.remove('invisible');
      } else {
        capsHint.classList.add('invisible');
      }
    }
    if (pass && capsHint) {
      pass.addEventListener('keydown', updateCaps);
      pass.addEventListener('keyup', updateCaps);
      pass.addEventListener('blur', () => capsHint.classList.add('invisible'));
    }
  })();
</script>
{% endblock %}
