{% extends "base.html" %}
{% block title %}Forgot / Reset Password - PersonFinder{% endblock %}

{% block content %}
<div class="flex min-h-screen justify-center items-start sm:items-center flex-col w-full px-4 sm:px-6 lg:px-8 mt-[6rem] sm:mt-[8rem]">

  <!-- Heading Card (outside the main card) -->
  <div class="w-full flex justify-center mb-10">
    <div
      class="card-base card-float rounded-2xl border border-blue-400/20 bg-blue-900/40 backdrop-blur p-5 sm:p-6 shadow-xl relative overflow-hidden max-w-3xl text-center"
      role="banner"
      aria-label="Password Reset heading card"
    >
      <!-- Decorative dots overlay -->
      <div class="absolute inset-0 pointer-events-none opacity-[.08]"
           style="background-image: radial-gradient(#3b82f6 1px, transparent 1px); background-size: 20px 20px;"></div>

      <!-- Heading & Description -->
      <div class="relative z-10">
        {% if token_valid %}
          <h2 class="text-3xl sm:text-4xl font-extrabold text-white mb-3">
            Set New Admin Password
          </h2>
          <p class="text-blue-100/90 text-sm sm:text-base max-w-2xl mx-auto leading-relaxed px-2">
            Enter your new password below to securely reset your admin account.
          </p>
        {% else %}
          <h2 class="text-3xl sm:text-4xl font-extrabold text-white mb-3">
            Reset Admin Password
          </h2>
          <p class="text-blue-100/90 text-sm sm:text-base max-w-2xl mx-auto leading-relaxed px-2">
            Enter your registered admin email to receive a
            <span class="bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 bg-clip-text text-transparent animate-gradient font-semibold">
              password reset link
            </span>.
          </p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Reset Password Card (main content) -->
  <div class="bg-white/10 backdrop-blur-md shadow-xl rounded-2xl p-8 w-full max-w-md md:max-w-lg 
              border border-gray-700 transition-transform duration-300 transform hover:scale-105 animate-slideFadeIn mx-auto">

    <!-- Flash Messages (inside the card, above form) -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="space-y-2 mb-4">
          {% for category, message in messages %}
            <div class="text-sm px-3 py-2 rounded-lg
                        {% if category == 'error' %} bg-red-500/20 text-red-300 border border-red-500/40
                        {% elif category == 'success' %} bg-green-500/20 text-green-300 border border-green-500/40
                        {% else %} bg-gray-500/20 text-gray-200 border border-gray-500/40 {% endif %}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% if token_valid %}
      {# ========= Set New Password (Token-based) ========= #}
      <form method="POST" action="" class="space-y-5" autocomplete="off">
        <div>
          <label for="password" class="block text-sm font-medium text-gray-200">New Password</label>
          <input id="password" name="password" type="password" required
                 class="mt-1 block w-full px-4 py-2 rounded-xl bg-gray-800/60 border border-gray-600 
                        text-gray-100 focus:ring-2 focus:ring-blue-500"
                 placeholder="Enter new password"
                 autocomplete="new-password" spellcheck="false" autocapitalize="none" autocorrect="off">
        </div>

        <div>
          <label for="confirm_password" class="block text-sm font-medium text-gray-200">Confirm Password</label>
          <input id="confirm_password" name="confirm_password" type="password" required
                 class="mt-1 block w-full px-4 py-2 rounded-xl bg-gray-800/60 border border-gray-600 
                        text-gray-100 focus:ring-2 focus:ring-blue-500"
                 placeholder="Confirm new password"
                 autocomplete="new-password" spellcheck="false" autocapitalize="none" autocorrect="off">
        </div>

        <div>
          <button type="submit" 
                  class="login-gradient-btn w-full py-2 px-4 rounded-xl bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 
                         text-white font-semibold shadow-lg hover:opacity-90 transition relative overflow-hidden">
            Update Password
          </button>
        </div>
      </form>

    {% else %}
      {# ========= Request Reset Link (Email-based) ========= #}
      <form method="POST" action="{{ url_for('forgot_password') }}" class="space-y-5" autocomplete="off" novalidate>
        <div>
          <label for="email" class="block text-sm font-medium text-gray-200">Admin Email</label>
          <input id="email" name="email" type="email" required
                 class="mt-1 block w-full px-4 py-2 rounded-xl bg-gray-800/60 border border-gray-600 
                        text-gray-100 focus:ring-2 focus:ring-blue-500"
                 placeholder="admin@example.com"
                 autocomplete="email" spellcheck="false" autocapitalize="none" autocorrect="off">
        </div>
        <div>
          <button type="submit" 
                  class="login-gradient-btn w-full py-2 px-4 rounded-xl bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 
                         text-white font-semibold shadow-lg hover:opacity-90 transition relative overflow-hidden">
            Send Reset Link
          </button>
        </div>
      </form>
    {% endif %}

    <!-- Back to Login -->
    <p class="mt-6 text-center text-gray-400 text-sm">
      Remembered your password? 
      <a href="{{ url_for('login') }}" class="text-blue-400 hover:text-blue-300 font-semibold">Login</a>
    </p>
  </div>

  <!-- Divider -->
  <div class="relative w-full flex justify-center mt-16 mb-16">
    <div class="h-px w-3/4 sm:w-2/3 lg:w-1/2 bg-gradient-to-r from-transparent via-gray-400/40 to-transparent"></div>
    <span class="absolute -top-3 bg-blue-900 text-gray-200 text-xs sm:text-sm px-3 py-1 rounded-full shadow-md tracking-wide">
      Security
    </span>
  </div>

  <!-- Info Box for Password Reset -->
  <div class="info-box bg-indigo-900/40 border border-indigo-500/30 rounded-xl p-5 shadow-lg 
              max-w-2xl mx-auto text-center mb-16 animate-slide-in animate-pulse-slow">
    <div class="flex justify-center mb-3">
      <svg xmlns="http://www.w3.org/2000/svg" 
           class="h-6 w-6 text-purple-400 animate-bounce" 
           fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
              d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    </div>
    <p class="max-w-lg mx-auto text-center text-gray-300 text-sm sm:text-base leading-relaxed px-4">
      This page allows authorized administrators to 
      <span class="text-yellow-300 font-semibold">securely reset their password</span>.  
      Reset links are <span class="text-red-300 font-medium">time-limited</span> and can only be used once.  
      <span class="text-green-300 font-medium">Do not share your reset link or credentials with anyone.</span>
    </p>
  </div>
</div>

<!-- Styles -->
<style>
  .animate-gradient { background-size: 200% 200%; animation: gradientShift 6s ease infinite; }
  @keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  .card-float { animation: floaty 6.5s ease-in-out infinite; }
  @keyframes floaty {
    0% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
    100% { transform: translateY(0); }
  }
  @media (prefers-reduced-motion: reduce) { .card-float { animation: none !important; } }

  @keyframes slideFadeIn {
    0% { opacity: 0; transform: translateY(30px); }
    100% { opacity: 1; transform: translateY(0); }
  }
  .animate-slideFadeIn { animation: slideFadeIn 0.8s ease-out forwards; }

  /* Button shimmer */
  .login-gradient-btn { position: relative; overflow: hidden; -webkit-tap-highlight-color: transparent; }
  .login-gradient-btn::after {
    content: "";
    position: absolute;
    left: -60%; top: 0; width: 60%; height: 100%;
    background: linear-gradient(120deg, rgba(255,255,255,0.28), rgba(255,255,255,0.08), rgba(255,255,255,0.28));
    transform: skewX(-20deg);
    transition: left 0.9s ease;
    pointer-events: none;
  }
  .login-gradient-btn:hover::after { left: 150%; }
  .login-gradient-btn:active::after { left: 150%; transition-duration: 0.45s; }
  .login-gradient-btn.shimmer-touch::after { left: 150%; transition-duration: 0.7s; }

  @keyframes pulseSlow { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); } }
  .animate-pulse-slow { animation: pulseSlow 2.5s ease-in-out infinite; }
</style>

<!-- Mobile tap shimmer -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const buttons = document.querySelectorAll('.login-gradient-btn');
    buttons.forEach(btn => {
      btn.addEventListener('touchstart', () => {
        btn.classList.add('shimmer-touch');
        setTimeout(() => btn.classList.remove('shimmer-touch'), 800);
      }, { passive: true });

      btn.addEventListener('keydown', e => {
        if (e.key === 'Enter' || e.key === ' ') {
          btn.classList.add('shimmer-touch');
          setTimeout(() => btn.classList.remove('shimmer-touch'), 800);
        }
      });
    });
  });
</script>
{% endblock %}
