<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{% block title %}PersonFinder{% endblock %}</title>
  <meta name="description" content="Find and connect with people easily using PersonFinder.">

  <!-- Favicons -->
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- AOS Animation Library -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>

  <style>
    nav a.active-link { font-weight: 600; color: #ffffff; text-decoration: none; }

    /* Slide down animation */
    @keyframes slideDown { 0% { opacity:0; transform:translateY(-10px); } 100% { opacity:1; transform:translateY(0); } }
    .animate-slide-down { animation: slideDown 0.5s ease-out forwards; }

    /* Card shimmer effect */
    .card-hover { position: relative; overflow: hidden; border-radius: 1rem; }
    .card-hover::before {
      content: ""; position: absolute; top: 0; left: -75%; width: 50%; height: 100%;
      transform: skewX(-20deg); animation: slideGlow 3s linear infinite; pointer-events: none;
    }
    @keyframes slideGlow { 0% { left:-75%; } 100% { left:125%; } }

    .card-glow-blue::before { background: linear-gradient(120deg, rgba(59,130,246,0.05), rgba(59,130,246,0.4), rgba(59,130,246,0.05)); }
    .card-glow-green::before { background: linear-gradient(120deg, rgba(16,185,129,0.05), rgba(16,185,129,0.4), rgba(16,185,129,0.05)); }
    .card-glow-pink::before { background: linear-gradient(120deg, rgba(236,72,153,0.05), rgba(236,72,153,0.4), rgba(236,72,153,0.05)); }

    .card-glow-blue:hover { background: rgba(59,130,246,0.35); border-color: transparent; }
    .card-glow-green:hover { background: rgba(16,185,129,0.35); border-color: transparent; }
    .card-glow-pink:hover { background: rgba(236,72,153,0.35); border-color: transparent; }

    /* Responsive adjustments */
    @media (max-width:640px){
      .grid-cols-3 { grid-template-columns: 1fr !important; }
      .max-w-5xl { max-width: 100%; padding: 0 1rem; }
    }

    /* Privacy Popup Overlay */
    #policy-popup { background: rgba(0, 0, 0, 0.65); backdrop-filter: blur(4px); }
  </style>
</head>

<body class="bg-gradient-to-br from-indigo-900 to-blue-700 text-white min-h-screen flex flex-col">

  {% include 'partials/_header.html' %}

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div id="flash-container"
           class="fixed right-4 space-y-3 z-[1400] w-[90%] max-w-sm"
           style="top: calc(var(--pf-header-h, 0px) + 12px);">
        {% for category, message in messages %}
          {% set color = 
            'bg-green-500 text-white' if category=='success' else
            'bg-red-500 text-white' if category=='error' else
            'bg-yellow-500 text-black'
          %}
          <div class="flash-message flex items-center justify-between {{ color }} px-4 py-3 rounded-xl shadow-lg animate-slide-down relative">
            <span class="font-medium">{{ message }}</span>
            <button onclick="this.parentElement.remove()" class="ml-3 text-xl leading-none hover:opacity-75" aria-label="Dismiss message">&times;</button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <main class="flex-grow">
    <div id="main-content" class="flex flex-col justify-start items-center px-4 sm:px-6 lg:px-8 pt-0 pb-12 sm:pb-16 lg:pb-20" data-aos="fade-up">
      <div class="text-center max-w-5xl w-full">
        {% block content %}{% endblock %}
      </div>
    </div>
  </main>

  <div class="w-full bg-gradient-to-t from-indigo-900 to-transparent h-12 sm:h-16 lg:h-20"></div>

  <footer class="bg-indigo-900 text-white">
    {% include 'partials/_footer.html' %}
  </footer>

  <!-- Privacy & Terms Popup -->
  <div id="policy-popup" class="fixed inset-0 z-[2000] hidden flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
    <div class="bg-white text-gray-800 rounded-2xl shadow-2xl max-w-lg w-full p-6 sm:p-8 animate-slide-down">
      <h2 class="text-xl sm:text-2xl font-bold mb-4 text-center">We value your privacy</h2>
      <p class="mb-4 text-sm sm:text-base text-gray-600 text-center">
        By using PersonFinder, you agree to our 
        <a href="{{ url_for('privacy_policy') }}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline">Privacy Policy</a> 
        and 
        <a href="{{ url_for('terms') }}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline">Terms of Service</a>.
      </p>
      <div class="flex justify-center gap-4 mt-6">
        <button id="accept-policy" class="bg-green-500 hover:bg-green-600 text-white px-5 py-2 rounded-lg font-medium shadow-md transition">Accept</button>
        <button id="reject-policy" class="bg-red-500 hover:bg-red-600 text-white px-5 py-2 rounded-lg font-medium shadow-md transition">Reject</button>
      </div>
    </div>
  </div>

  <div id="pf-feedback-toast"
     class="fixed bottom-6 right-6 z-[2000] bg-emerald-600 text-white px-4 py-3 rounded-xl shadow-xl opacity-0 pointer-events-none transition-all duration-300 text-sm flex items-center gap-2">
  <i data-lucide="check-circle" class="w-4 h-4"></i>
  <span id="pf-feedback-toast-text"></span>
</div>

<div id="pf-feedback-toast-error"
     class="fixed bottom-6 right-6 z-[2000] bg-rose-600 text-white px-4 py-3 rounded-xl shadow-xl opacity-0 pointer-events-none transition-all duration-300 text-sm flex items-center gap-2">
  <i data-lucide="alert-circle" class="w-4 h-4"></i>
  <span id="pf-feedback-toast-error-text"></span>
</div>

  <!-- Global script -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      (function ensureHeaderHeightVar(){
        var header = document.getElementById('pf-header');
        function setVar(){
          if (!header) return;
          var h = Math.round(header.getBoundingClientRect().height) || 0;
          document.documentElement.style.setProperty('--pf-header-h', h + 'px');
        }
        setVar();
        window.addEventListener('resize', setVar);
      })();

      if (window.AOS && typeof AOS.init === 'function') {
        AOS.init();
      }

      // Auto-hide flash messages
      setTimeout(function () {
        document.querySelectorAll(".flash-message").forEach(function (el) {
          el.style.transition = "opacity 1s ease";
          el.style.opacity = "0";
          setTimeout(function () { if (el && el.parentElement) { el.remove(); } }, 1000);
        });
      }, 4000);

      // Privacy popup
      var popup = document.getElementById("policy-popup");
      var acceptBtn = document.getElementById("accept-policy");
      var rejectBtn = document.getElementById("reject-policy");

      if (popup && !localStorage.getItem("policyAccepted")) {
        popup.classList.remove("hidden");
      }

      if (acceptBtn && popup) {
        acceptBtn.addEventListener("click", function () {
          localStorage.setItem("policyAccepted", "true");
          popup.classList.add("hidden");
        });
      }
      if (rejectBtn) {
        rejectBtn.addEventListener("click", function () {
          alert("You must accept the Privacy Policy & Terms to use this site.");
        });
      }

      // Mobile menu
      var menuBtn = document.getElementById('menu-btn');
      var mobileMenuContainer = document.getElementById('mobile-menu-container');
      var openIcon = document.getElementById('menu-open-icon');
      var closeIcon = document.getElementById('menu-close-icon');
      var menuLinks = document.querySelectorAll('.menu-link');

      function closeMenu(){
        if(!mobileMenuContainer) return;
        mobileMenuContainer.classList.remove('open','pointer-events-auto');
        mobileMenuContainer.classList.add('pointer-events-none');
        if (openIcon) openIcon.classList.remove('hidden');
        if (closeIcon) closeIcon.classList.add('hidden');
        menuLinks.forEach(function(l){ l.classList.remove('show'); });
        if (menuBtn) menuBtn.setAttribute('aria-expanded','false');
      }

      if (menuBtn && mobileMenuContainer) {
        menuBtn.addEventListener('click', function (){
          var isOpen = mobileMenuContainer.classList.toggle('open');
          if (openIcon) openIcon.classList.toggle('hidden');
          if (closeIcon) closeIcon.classList.toggle('hidden');

          if(isOpen){
            mobileMenuContainer.classList.remove('pointer-events-none');
            mobileMenuContainer.classList.add('pointer-events-auto');
            menuBtn.setAttribute('aria-expanded','true');
            menuLinks.forEach(function (link, index){
              link.classList.remove('show');
              setTimeout(function(){ link.classList.add('show'); }, index * 150);
              link.addEventListener('click', closeMenu, { once:true });
            });
          } else {
            closeMenu();
          }
        });
      }

      document.addEventListener('click', function (e){
        if(mobileMenuContainer &&
           mobileMenuContainer.classList.contains('open') &&
           !mobileMenuContainer.contains(e.target) &&
           e.target !== menuBtn && (!menuBtn || !menuBtn.contains(e.target))){
          closeMenu();
        }
      });

      // Highlight current nav link
      var currentPath = window.location.pathname.replace(/\/$/,'');
      document.querySelectorAll('nav a').forEach(function (link){
        var href = link.getAttribute('href');
        if (!href) return;
        var linkPath = href.replace(/\/$/,'');
        if (linkPath && currentPath.endsWith(linkPath)) {
          link.classList.add('active-link');
        }
      });

      // Push notifications
      var PERSON_ID = "{{ person_id|default('') }}";
      if (PERSON_ID && 'serviceWorker' in navigator && navigator.serviceWorker) {
        navigator.serviceWorker.register('/static/service-worker.js').then(function (reg){
          return reg.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array("{{ VAPID_PUBLIC_KEY }}")
          });
        }).then(function (subscription){
          return fetch('/save-subscription?person_id=' + encodeURIComponent(PERSON_ID), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(subscription)
          });
        }).then(function (resp){ return resp.json(); })
          .then(function (data){
            if (data && data.success) console.log("Subscription saved!");
          }).catch(function (err){
            console.error("Push subscription failed or save error:", err);
          });
      }

      function urlBase64ToUint8Array(base64String){
        var padding = '='.repeat((4 - base64String.length % 4) % 4);
        var base64 = (base64String + padding).replace(/-/g,'+').replace(/_/g,'/');
        var rawData = atob(base64);
        var outputArray = new Uint8Array(rawData.length);
        for (var i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
        return outputArray;
      }
    });
  </script>

  {# ðŸ”¹ Page-specific scripts (like your admin login eye-toggle) #}
  {% block scripts %}{% endblock %}

</body>
</html>
