<!-- partials/_header.html - PersonFinder polished header (mobile dropdown cleaned) -->
<header id="pf-header"
  class="fixed top-0 inset-x-0 z-[1300] bg-indigo-900/95 border-b border-white/10 backface-visible">
  {% set ep = request.endpoint %}
  <div class="mx-auto max-w-7xl px-4 sm:px-6">
    <div class="h-16 md:h-20 flex items-center justify-between gap-3">

      <!-- BRAND -->
      <a href="{{ url_for('home') }}" class="flex items-center gap-3 min-w-0" aria-label="Go to homepage">
        <img src="{{ url_for('static', filename='images/elderly.jpeg') }}"
             alt="PersonFinder logo"
             class="w-10 h-10 md:w-11 md:h-11 rounded-xl shadow-lg flex-shrink-0" />
        <div class="min-w-0 leading-tight">
          <div class="text-xl md:text-2xl font-extrabold tracking-tight
                      bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400
                      bg-[length:200%_200%] bg-clip-text text-transparent animate-gradient">
            PersonFinder
          </div>
          <p class="text-xs md:text-sm text-white/80 truncate">Reunite Loved Ones</p>
        </div>
      </a>

      <!-- DESKTOP NAV (stable: no JS hide) -->
      <nav id="pf-desktop-nav" class="hidden md:flex items-center gap-2 ml-6" aria-label="Primary navigation">
        <a href="{{ url_for('home') }}" class="pf-link {% if ep=='home' %}is-active{% endif %}">Home</a>
        <a href="{{ url_for('register') }}" class="pf-link {% if ep=='register' %}is-active{% endif %}">Register</a>
        <a href="{{ url_for('search') }}" class="pf-link {% if ep=='search' %}is-active{% endif %}">Search</a>
        <a href="{{ url_for('donate_page') }}" class="pf-link {% if ep=='donate_page' %}is-active{% endif %}">Donate</a>
        <a href="{{ url_for('about') }}" class="pf-link {% if ep=='about' %}is-active{% endif %}">About</a>
        <a href="{{ url_for('developers') }}" class="pf-link {% if ep=='developers' %}is-active{% endif %}">Developers</a>
      </nav>

      <!-- RIGHT: admin / user area -->
      <div class="flex items-center gap-3">

        <!-- Admin / Username button (desktop only) -->
        <div class="hidden md:inline-flex items-center relative">
          <a id="pf-admin-desktop"
             href="{% if current_user.is_authenticated and (current_user.role|default('')|lower) == 'admin' %}{{ url_for('admin_dashboard') }}{% else %}{{ url_for('login') }}{% endif %}"
             class="pf-admin-cta inline-flex items-center gap-2 rounded-lg px-3 py-2 shadow-sm focus:outline-none focus-visible:ring-2 focus-visible:ring-white/60"
             role="button" aria-haspopup="false">

            <!-- icon -->
            <svg class="w-5 h-5 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" aria-hidden="true">
              <path d="M12 12c2.5 0 4-2 4-4s-1.5-4-4-4-4 2-4 4 1.5 4 4 4z"/>
              <path d="M4 20c0-3.3 3.6-6 8-6s8 2.7 8 6"/>
            </svg>

            <!-- label: Admin when anonymous, else username -->
            <span id="pf-admin-label" class="font-medium text-sm">
              {% if current_user.is_authenticated %}
                {{ current_user.username|default('User')|truncate(18) }}
              {% else %}
                Admin
              {% endif %}
            </span>

            <!-- live badge -->
            <span id="pf-admin-badge" class="pf-badge hidden" aria-live="polite" aria-atomic="true">0</span>
          </a>
        </div>

        <!-- SQUARE hamburger (mobile only) -->
        <button id="pf-menu-btn" aria-controls="pf-mobile-drawer" aria-expanded="false"
                class="md:hidden relative inline-grid place-items-center w-11 h-11 rounded-lg
       bg-white/[0.04] border border-white/[0.10]
       backdrop-blur-sm
       transition-colors transition-transform duration-200 ease-out
       active:scale-[0.97]
       focus:outline-none focus-visible:ring-2 focus-visible:ring-white/50"
                title="Open menu">
          <span class="sr-only">Open menu</span>
          <!-- square hamburger lines that morph to X -->
          <svg class="w-6 h-6 transform transition-all" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" aria-hidden="true">
            <path class="pf-line-1" d="M4 7h16"></path>
            <path class="pf-line-2" d="M4 12h16"></path>
            <path class="pf-line-3" d="M4 17h16"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>
</header>

<!-- OVERLAY -->
<div id="pf-overlay" class="fixed inset-0 bg-black/60 opacity-0 pointer-events-none transition-opacity duration-300 z-[1200]" aria-hidden="true"></div>

<!-- MOBILE DRAWER -->
<aside id="pf-mobile-drawer"
       role="dialog" aria-modal="true" aria-labelledby="pf-mobile-title" tabindex="-1"
       class="fixed left-0 right-0 top-[64px] z-[1250] transform -translate-y-2 opacity-0 pointer-events-none
              rounded-b-2xl shadow-2xl overflow-hidden transition-all duration-300 md:hidden">

  <!-- drawer background (glass) -->
  <div class="absolute inset-0 bg-gradient-to-b from-indigo-800/88 to-indigo-900/98 backdrop-blur-md"></div>

  <div class="relative px-4 pt-4 pb-6">
    <!-- drawer top bar (admin only, no title/brand) -->
    <div class="flex items-center justify-end mb-3">
      <a id="pf-admin-mobile"
         href="{% if current_user.is_authenticated and (current_user.role|default('')|lower) == 'admin' %}{{ url_for('admin_dashboard') }}{% else %}{{ url_for('login') }}{% endif %}"
         class="inline-flex items-center gap-2 rounded-xl px-4 py-2.5 bg-white/8 border border-white/15 font-semibold shadow-none">
        <svg class="w-4 h-4 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" aria-hidden="true">
          <path d="M12 12c2.5 0 4-2 4-4s-1.5-4-4-4-4 2-4 4 1.5 4 4 4z"/>
          <path d="M4 20c0-3.3 3.6-6 8-6s8 2.7 8 6"/>
        </svg>
        <span id="pf-admin-mobile-label">
          {% if current_user.is_authenticated %}
            {{ current_user.username|default('User')|truncate(18) }}
          {% else %}
            Admin
          {% endif %}
        </span>
      </a>
    </div>


    <nav class="space-y-2" aria-label="Mobile primary">
      <a href="{{ url_for('home') }}" class="block pf-mobile-link {% if ep=='home' %}is-active{% endif %}">Home</a>
      <a href="{{ url_for('register') }}" class="block pf-mobile-link {% if ep=='register' %}is-active{% endif %}">Register</a>
      <a href="{{ url_for('search') }}" class="block pf-mobile-link {% if ep=='search' %}is-active{% endif %}">Search</a>
      <a href="{{ url_for('donate_page') }}" class="block pf-mobile-link {% if ep=='donate_page' %}is-active{% endif %}">Donate</a>
      <a href="{{ url_for('about') }}" class="block pf-mobile-link {% if ep=='about' %}is-active{% endif %}">About</a>
      <a href="{{ url_for('developers') }}" class="block pf-mobile-link {% if ep=='developers' %}is-active{% endif %}">Developers</a>
    </nav>

    <!-- admin quick actions / footer inside drawer -->
    <div class="mt-5 pt-4 border-t border-white/6">
      {% if current_user.is_authenticated %}
      <div class="mt-3 grid gap-2">
        {% if (current_user.role|default('')|lower) == 'admin' %}
        <a href="{{ url_for('admin_dashboard') }}" class="block text-center px-3 py-2 rounded-lg bg-white/4">Go to Dashboard</a>
        {% endif %}
        <a href="{{ url_for('logout') }}" class="block text-center px-3 py-2 rounded-lg bg-white/4">Logout</a>
      </div>
      {% else %}
      <p class="mt-3 text-xs text-white/70">Admin access enables real-time alerts and dashboard controls.</p>
      {% endif %}
    </div>
  </div>
</aside>

<!-- TOASTS (small notification) -->
<div id="pf-toasts" aria-live="polite" class="fixed bottom-6 right-6 z-[1400] space-y-2"></div>

<!-- ================= STYLES: header + drawer + controls (mobile dropdown optimized) ================= -->
<style>
  :root {
    --pf-badge-bg: #ef4444;
    --pf-glass: rgba(255,255,255,0.05);
    --pf-glass-strong: rgba(255,255,255,0.08);
  }

  /* ---------- Brand gradient ---------- */
  @keyframes gradientMove {
    0% { background-position:0% 50% }
    50% { background-position:100% 50% }
    100% { background-position:0% 50% }
  }
  .animate-gradient {
    background-size:200% 200%;
    animation:gradientMove 6s ease infinite;
  }

  /* ---------- Desktop nav links ---------- */
  .pf-link{
    display:inline-flex;
    align-items:center;
    gap:.5rem;
    padding:.5rem .9rem;
    border-radius:.65rem;
    color:rgba(255,255,255,.95);
    font-weight:600;
    text-decoration:none;
    transition:
      transform .18s ease,
      background .18s ease,
      color .18s ease;
  }
  .pf-link:hover{
    transform: translateY(-1.5px);
    background: rgba(255,255,255,0.06);
    color:#fff;
  }
  .pf-link.is-active{
    background: rgba(255,255,255,0.05);
  }
  .pf-link.is-active::after{
    content:"";
    display:block;
    width:6px;
    height:6px;
    margin-top:4px;
    background:#fff;
    border-radius:9999px;
  }

  /* ---------- Admin CTA ---------- */
  .pf-admin-cta{
    background: var(--pf-glass);
    border:1px solid rgba(255,255,255,0.12);
    padding:.45rem .7rem;
    border-radius:.75rem;
    color:#fff;
    text-decoration:none;
    transition: background .18s ease, transform .12s ease;
  }
  .pf-admin-cta:hover{
    background: var(--pf-glass-strong);
    transform: translateY(-1px);
  }
  .pf-admin-cta:focus{
    outline:none;
    box-shadow:
      0 8px 28px rgba(2,6,23,0.6),
      0 0 0 3px rgba(99,102,241,0.14);
  }

  /* ---------- Badge ---------- */
  .pf-badge{
    min-width:18px;
    height:18px;
    padding:0 6px;
    border-radius:9999px;
    background:var(--pf-badge-bg);
    font-size:11px;
    font-weight:700;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    color:white;
    box-shadow: 0 4px 12px rgba(14,28,38,0.35);
  }
  .pf-badge.hidden{ display:none !important; }

  /* ---------- Mobile drawer (optimized) ---------- */
  #pf-mobile-drawer{
    width:100%;
    left:0;
    right:0;
  }
  /* Mobile links: remove separation shadows, make compact and clean */
  #pf-mobile-drawer .pf-mobile-link{
    display:block;
    padding:.85rem .95rem;
    border-radius:12px;
    background: transparent; /* remove shadow/backplate */
    color:#fff;
    font-weight:700;
    text-decoration:none;
    transition: transform .14s ease, background .14s ease;
    box-shadow: none; /* explicit removal */
    border: 1px solid transparent;
  }
  #pf-mobile-drawer .pf-mobile-link:hover{
    transform: translateY(-2px);
    background: rgba(255,255,255,0.03);
  }

  /* Only the active mobile link gets the premium animation / gradient */
  #pf-mobile-drawer .pf-mobile-link.is-active{
    background: linear-gradient(90deg, rgba(99,102,241,0.12), rgba(124,58,237,0.12));
    border: 1px solid rgba(124,58,237,0.18);
    color: #fff;
    box-shadow: 0 8px 30px rgba(99,102,241,0.08);
    position: relative;
    overflow: hidden;
    border-radius:12px;
    animation: premiumFloat 2200ms ease-in-out infinite;
  }

  /* subtle float for "premium" active state */
  @keyframes premiumFloat {
    0% { transform: translateY(0); }
    50% { transform: translateY(-2px); }
    100% { transform: translateY(0); }
  }

  /* make the active link show the gradient shimmer on its text */
  #pf-mobile-drawer .pf-mobile-link.is-active {
    background-image: linear-gradient(90deg, #7c3aed 0%, #06b6d4 50%, #f472b6 100%);
    background-size: 200% 100%;
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    color: transparent; /* fallback */
    animation: mobileActiveGradient 3.5s linear infinite;
  }
  @keyframes mobileActiveGradient{
    0%{ background-position:0% 50%; }
    50%{ background-position:100% 50%; }
    100%{ background-position:0% 50%; }
  }

  /* ensure readability for the active link when gradient is applied */
  #pf-mobile-drawer .pf-mobile-link.is-active::after{
    content: attr(data-label);
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: transparent;
  }

  #pf-overlay.open{
    opacity:1;
    pointer-events:auto;
  }
  #pf-mobile-drawer.open{
    transform:none;
    opacity:1;
    pointer-events:auto;
    top:64px;
  }

  /* ---------- Hamburger (calm & smooth) ---------- */
  #pf-menu-btn{
    background: rgba(255,255,255,0.04);
    border:1px solid rgba(255,255,255,0.10);
    box-shadow: 0 6px 20px rgba(2,6,23,0.35);
    transition:
      background .18s ease,
      transform .12s ease,
      box-shadow .18s ease;
  }
  #pf-menu-btn:hover{
    background: rgba(255,255,255,0.07);
  }
  #pf-menu-btn:active{
    transform: scale(0.97);
  }
  #pf-menu-btn.open{
    background: rgba(255,255,255,0.09);
    transform: translateY(-1px);
  }

  #pf-menu-btn svg{
    transition:
      transform 280ms cubic-bezier(.2,.7,.3,1),
      opacity 200ms ease;
  }
  #pf-menu-btn .pf-line-1,
  #pf-menu-btn .pf-line-2,
  #pf-menu-btn .pf-line-3{
    stroke: rgba(255,255,255,0.85);
    transition:
      transform 260ms cubic-bezier(.2,.8,.3,1),
      opacity 180ms ease;
  }

  /* Morph to X (gentle) */
  #pf-menu-btn.open .pf-line-1{
    transform: translateY(4px) rotate(40deg);
  }
  #pf-menu-btn.open .pf-line-2{
    opacity:0;
  }
  #pf-menu-btn.open .pf-line-3{
    transform: translateY(-4px) rotate(-40deg);
  }

  /* ---------- Toast ---------- */
  .pf-toast{
    min-width:240px;
    max-width:380px;
    background: linear-gradient(
      180deg,
      rgba(255,255,255,0.06),
      rgba(255,255,255,0.04)
    );
    border:1px solid rgba(255,255,255,0.08);
    color:#fff;
    padding:12px 14px;
    border-radius:14px;
    box-shadow: 0 10px 30px rgba(2,6,23,0.6);
    display:flex;
    gap:8px;
    align-items:flex-start;
    transform: translateY(12px);
    opacity:0;
    transition: transform .28s ease, opacity .28s ease;
  }
  .pf-toast.show{
    transform: translateY(0);
    opacity:1;
  }
  .pf-toast .pf-toast-title{
    font-weight:700;
    font-size:.95rem;
  }
  .pf-toast .pf-toast-body{
    font-size:.87rem;
    color: rgba(255,255,255,0.88);
  }

  /* ---------- Reduced motion ---------- */
  @media (prefers-reduced-motion: reduce){
    *{
      transition:none !important;
      animation:none !important;
    }
  }
</style>

<!-- ================= SCRIPTS: drawer, badge, Socket.IO hookup and toasts (minor mobile focus improvements) ================= -->
<script>
document.addEventListener('DOMContentLoaded', function(){
  const btn = document.getElementById('pf-menu-btn');
  const drawer = document.getElementById('pf-mobile-drawer');
  const overlay = document.getElementById('pf-overlay');
  const adminBadge = document.getElementById('pf-admin-badge');
  const adminBadgeMobile = document.getElementById('pf-admin-badge-mobile');
  const adminLabel = document.getElementById('pf-admin-label');
  const adminLabelMobile = document.getElementById('pf-admin-mobile-label');
  const toastsRoot = document.getElementById('pf-toasts');

  function openDrawer(){
    if (!drawer || !overlay) return;
    btn?.classList.add('open');
    btn?.setAttribute('aria-expanded','true');
    drawer.classList.add('open');
    overlay.classList.add('open');
    document.documentElement.style.overflow = 'hidden';
    // focus the active mobile link if present, else first link
    const active = drawer.querySelector('.pf-mobile-link.is-active');
    const first = active || drawer.querySelector('a.pf-mobile-link') || drawer;
    first && first.focus();
  }
  function closeDrawer(){
    if (!drawer || !overlay) return;
    btn?.classList.remove('open');
    btn?.setAttribute('aria-expanded','false');
    drawer.classList.remove('open');
    overlay.classList.remove('open');
    document.documentElement.style.overflow = '';
  }

  btn?.addEventListener('click', function(e){
    e.preventDefault();
    (btn.classList.contains('open')) ? closeDrawer() : openDrawer();
  });
  overlay?.addEventListener('click', closeDrawer);
  document.addEventListener('keydown', function(e){
    if (e.key === 'Escape') closeDrawer();
  });

  function setBadge(n){
    const val = Number(n) || 0;
    if (val > 0){
      adminBadge?.classList.remove('hidden');
      adminBadgeMobile?.classList.remove('hidden');
      adminBadge && (adminBadge.textContent = String(val));
      adminBadgeMobile && (adminBadgeMobile.textContent = String(val));
    }else{
      adminBadge && adminBadge.classList.add('hidden');
      adminBadgeMobile && adminBadgeMobile.classList.add('hidden');
    }
  }
  function incBadge(delta=1){
    const cur = Number((adminBadge && adminBadge.textContent) || (adminBadgeMobile && adminBadgeMobile.textContent) || 0) || 0;
    setBadge(cur + delta);
  }
  window.incrementAdminBadge = function(n=1){ incBadge(n); };

  // initial poll â€” hits admin-protected endpoint; fails silently if unauthorized
  (function initUnreadCount(){
    fetch('/api/admin/alerts/unread-count', { credentials: 'same-origin' })
      .then(r => {
        if (!r.ok) throw r;
        return r.json();
      })
      .then(js => {
        if (js && typeof js.unread === 'number') setBadge(js.unread);
      })
      .catch(()=>{ /* ignore â€” endpoint protected or missing */ });
  })();

  // small toast helper
  function showToast(title, body, ttl = 6000){
    const el = document.createElement('div');
    el.className = 'pf-toast';
    el.setAttribute('role','status');
    el.innerHTML = `
      <div style="width:36px;height:36px;border-radius:8px;background:linear-gradient(90deg,#7c3aed,#06b6d4);display:flex;align-items:center;justify-content:center;font-weight:700;color:white">ðŸ””</div>
      <div style="flex:1;min-width:0">
        <div class="pf-toast-title">${title}</div>
        <div class="pf-toast-body">${body || ''}</div>
      </div>
      <button aria-label="dismiss" style="background:transparent;border:0;color:rgba(255,255,255,.7);font-weight:700">âœ•</button>
    `;
    const btnDismiss = el.querySelector('button');
    btnDismiss?.addEventListener('click', ()=> { hide(el); });

    toastsRoot.appendChild(el);
    // show
    requestAnimationFrame(()=> el.classList.add('show'));
    const timer = setTimeout(()=> hide(el), ttl);
    function hide(node){
      clearTimeout(timer);
      node.classList.remove('show');
      setTimeout(()=> node.remove(), 300);
    }
  }

  // ----- Socket.IO real-time hookup -----
  (function initSocketIO(){
    if (typeof io === 'undefined') {
      const s = document.createElement('script'); s.src = '/socket.io/socket.io.js'; s.async = true;
      s.onload = connectSocket;
      s.onerror = ()=>{/* no socket.io */};
      document.head.appendChild(s);
    } else {
      connectSocket();
    }

    function connectSocket(){
      try {
        const socket = io({ transports: ['websocket'], upgrade: true });

        socket.on('connect', () => console.debug('[socketio] connected', socket.id));
        socket.on('disconnect', (reason) => console.debug('[socketio] disconnected', reason));

        // server emits admin_alert payloads
        socket.on('admin_alert', (payload) => {
          try {
            if (payload && typeof payload.count === 'number') {
              setBadge(payload.count);
            } else {
              incBadge(1);
            }

            // show a toast for incoming alerts (if payload includes message/title)
            const title = (payload && payload.event) ? String(payload.event) : 'New alert';
            const body = (payload && payload.payload && payload.payload.rating) ? `Rating: ${payload.payload.rating}` :
                         (payload && payload.payload && payload.payload.name) ? `Name: ${payload.payload.name}` :
                         (payload && payload.message) ? payload.message : '';
            showToast(title, body, 6000);
          } catch (e){ console.error(e); }
        });

        socket.on('admin_alert_cleared', (payload) => { setBadge(0); showToast('Alerts cleared', 'All admin alerts marked read', 4000); });

      } catch (err) {
        console.debug('[socketio] not available', err);
      }
    }
  })();

  // ensure labels
  if (adminLabel && !adminLabel.textContent.trim()) adminLabel.textContent = 'Admin';
  if (adminLabelMobile && !adminLabelMobile.textContent.trim()) adminLabelMobile.textContent = 'Admin';
});
</script>
